<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BRS Pension Optimizer</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KP9WD9PCKQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KP9WD9PCKQ');
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #0a1628; }
    
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(90deg, #2a5a8a, #4a9aca);
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60b0e0, #3090c0);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    input[type="number"] {
      background: rgba(20,40,70,0.8);
      border: 1px solid rgba(100,150,200,0.3);
      border-radius: 8px;
      padding: 10px 14px;
      color: #e0f0ff;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 15px;
      width: 100%;
      outline: none;
    }
    
    input[type="number"]:focus {
      border-color: #60b0e0;
    }

    input[type="number"].compact {
      padding: 8px 10px;
      font-size: 14px;
    }
    
    .scenario-row:hover {
      background: rgba(60,120,180,0.15);
    }

    .entry-row {
      display: grid;
      grid-template-columns: 100px 1fr 40px;
      gap: 8px;
      align-items: center;
      padding: 6px 0;
    }

    .remove-btn {
      background: transparent;
      border: none;
      color: #a08080;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .remove-btn:hover {
      background: rgba(200,80,80,0.2);
      color: #f08080;
    }

    .empty-row input {
      border-style: dashed;
      background: rgba(20,40,70,0.4);
    }

    .empty-row input::placeholder {
      color: #506880;
    }

    select {
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2380a8c8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px !important;
    }

    select option {
      background: #1a2d4a;
      color: #e0f0ff;
    }
  </style>
</head>
<body>
   <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useMemo, useRef } = React;

    const GROUP1_TABLE_POST_2012 = {
      60: 1.45, 61: 1.6, 62: 1.75, 63: 1.9, 64: 2.05, 65: 2.2, 66: 2.35, 67: 2.5,
      68: 2.5, 69: 2.5, 70: 2.5, 71: 2.5, 72: 2.5, 73: 2.5, 74: 2.5
    };

    const GROUP1_TABLE_PRE_2012 = {
      41: 1.0, 42: 2.0, 43: 3.0, 44: 4.0, 45: 5.0, 46: 6.0, 47: 7.0, 48: 8.0,
      49: 9.0, 50: 10.0, 51: 11.0, 52: 12.0, 53: 13.0, 54: 14.0, 55: 15.0,
      56: 16.0, 57: 17.0, 58: 18.0, 59: 19.0, 60: 20.0, 61: 21.0, 62: 22.0,
      63: 23.0, 64: 24.0, 65: 25.0, 66: 25.0, 67: 25.0, 68: 25.0, 69: 25.0, 70: 25.0
    };

    const CONTRIBUTION_RATE = 0.11;

    // Official BRS cumulative interest factors to 12/31/2025
    // Derived from 2025 BRS worksheet by applying one additional year of compounding
    // Buyback Interest at 6.90% = annual compound rate of 3.45% (rate Ã· 2)
    const BUYBACK_CUM_FACTORS = {
      1977: 5.094057, 1978: 4.924172, 1979: 4.759954, 1980: 4.601212,
      1981: 4.447764, 1982: 4.299434, 1983: 4.156050, 1984: 4.017449,
      1985: 3.883469, 1986: 3.753957, 1987: 3.628764, 1988: 3.507747,
      1989: 3.390766, 1990: 3.277686, 1991: 3.168377, 1992: 3.062713,
      1993: 2.960573, 1994: 2.861840, 1995: 2.766399, 1996: 2.674141,
      1997: 2.584960, 1998: 2.498753, 1999: 2.415421, 2000: 2.334869,
      2001: 2.257002, 2002: 2.181732, 2003: 2.108972, 2004: 2.038639,
      2005: 1.970652, 2006: 1.904931, 2007: 1.841403, 2008: 1.779994,
      2009: 1.720632, 2010: 1.663249, 2011: 1.607782, 2012: 1.554162,
      2013: 1.502332, 2014: 1.452230, 2015: 1.403799, 2016: 1.356984,
      2017: 1.311728, 2018: 1.267984, 2019: 1.225696, 2020: 1.184820,
      2021: 1.145307, 2022: 1.107112, 2023: 1.070190, 2024: 1.034500,
      2025: 1.000000
    };

    // Actuarial Interest at 6.90% = annual compound rate of 6.90% (full rate)
    const ACTUARIAL_CUM_FACTORS = {
      1977: 24.599702, 1978: 23.011882, 1979: 21.526550, 1980: 20.137091,
      1981: 18.837316, 1982: 17.621437, 1983: 16.484039, 1984: 15.420055,
      1985: 14.424747, 1986: 13.493683, 1987: 12.622716, 1988: 11.807966,
      1989: 11.045805, 1990: 10.332840, 1991: 9.665893, 1992: 9.041995,
      1993: 8.458367, 1994: 7.912412, 1995: 7.401694, 1996: 6.923943,
      1997: 6.477027, 1998: 6.058959, 1999: 5.667875, 2000: 5.302036,
      2001: 4.959808, 2002: 4.639672, 2003: 4.340198, 2004: 4.060055,
      2005: 3.797992, 2006: 3.552846, 2007: 3.323523, 2008: 3.109002,
      2009: 2.908328, 2010: 2.720606, 2011: 2.545000, 2012: 2.380730,
      2013: 2.227063, 2014: 2.083314, 2015: 1.948844, 2016: 1.823053,
      2017: 1.705382, 2018: 1.595306, 2019: 1.492335, 2020: 1.396010,
      2021: 1.305903, 2022: 1.221612, 2023: 1.142761, 2024: 1.069000,
      2025: 1.000000
    };

    // Monthly interest rates for partial-year 2026 calculation
    const BUYBACK_MONTHLY_RATE = 0.002875;   // 6.90% / 200 / 12
    const ACTUARIAL_MONTHLY_RATE = 0.005750;  // 6.90% / 100 / 12

    const MONTH_NAMES = ['January','February','March','April','May','June',
      'July','August','September','October','November','December'];

    function App() {
      const [inputs, setInputs] = useState({
        currentAge: 45,
        brsJoinDate: 'post-2012',
        currentCityServiceYears: 1.5,
        expectedFinalSalary: 120000,
        salaryGrowthRate: 2.5,
        lifeExpectancy: 85,
        departureAge: null
      });
      
      const [edicYears, setEdicYears] = useState([]);
      const [entryMode, setEntryMode] = useState('manual');
      const [repaymentMonth, setRepaymentMonth] = useState(new Date().getMonth() + 1);
      const [repaymentYear] = useState(2026);
      
      const [quickFill, setQuickFill] = useState({
        startYear: 2020,
        endYear: 2024,
        startingSalary: 80000,
        annualRaise: 3
      });

      const [newYear, setNewYear] = useState('');
      const [newSalary, setNewSalary] = useState('');
      const salaryInputRef = useRef(null);
      const yearInputRef = useRef(null);
      
      const [selectedScenario, setSelectedScenario] = useState(null);

      const handleInputChange = (field, value) => {
        setInputs(prev => ({ ...prev, [field]: value }));
      };

      const addEntry = () => {
        const year = parseInt(newYear);
        const salary = parseFloat(newSalary);
        if (year && salary && year >= 1980 && year <= 2030 && salary > 0) {
          const updated = [...edicYears, { year, salary }].sort((a, b) => a.year - b.year);
          setEdicYears(updated);
          setNewYear('');
          setNewSalary('');
          setTimeout(() => yearInputRef.current?.focus(), 50);
        }
      };

      const handleYearKeyDown = (e) => {
        if (e.key === 'Enter' || e.key === 'Tab') {
          if (newYear && salaryInputRef.current) {
            e.preventDefault();
            salaryInputRef.current.focus();
          }
        }
      };

      const handleSalaryKeyDown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addEntry();
        }
      };

      const removeEdicYear = (index) => {
        setEdicYears(edicYears.filter((_, i) => i !== index));
      };

      const updateEdicYear = (index, field, value) => {
        const updated = [...edicYears];
        updated[index][field] = field === 'year' ? parseInt(value) || 0 : parseFloat(value) || 0;
        updated.sort((a, b) => a.year - b.year);
        setEdicYears(updated);
      };

      const applyQuickFill = () => {
        const { startYear, endYear, startingSalary, annualRaise } = quickFill;
        const years = [];
        for (let y = startYear; y <= endYear; y++) {
          const yearsFromStart = y - startYear;
          const salary = Math.round(startingSalary * Math.pow(1 + annualRaise / 100, yearsFromStart));
          years.push({ year: y, salary });
        }
        setEdicYears(years);
        setEntryMode('manual');
      };

      const clearAll = () => {
        setEdicYears([]);
        setNewYear('');
        setNewSalary('');
      };

      const buybackCalculation = useMemo(() => {
        let totalReducedRate = 0;
        let totalFullRate = 0;
        const breakdown = [];

        edicYears.forEach(({ year, salary }) => {
          const contribution = salary * CONTRIBUTION_RATE;
          
          // Official BRS worksheet method:
          // 1. contribution Ã— cumulative factor = balance at 12/31/2025
          // 2. balance Ã— (month Ã— monthly rate) = partial 2026 interest
          // 3. total = balance + partial year interest
          
          const cumFactorReduced = BUYBACK_CUM_FACTORS[year] || Math.pow(1.0345, 2025 - year);
          const bal2025Reduced = contribution * cumFactorReduced;
          const partialReduced = bal2025Reduced * (repaymentMonth * BUYBACK_MONTHLY_RATE);
          const amountReduced = bal2025Reduced + partialReduced;
          
          const cumFactorFull = ACTUARIAL_CUM_FACTORS[year] || Math.pow(1.069, 2025 - year);
          const bal2025Full = contribution * cumFactorFull;
          const partialFull = bal2025Full * (repaymentMonth * ACTUARIAL_MONTHLY_RATE);
          const amountFull = bal2025Full + partialFull;
          
          totalReducedRate += amountReduced;
          totalFullRate += amountFull;
          
          breakdown.push({ 
            year, salary, contribution,
            cumFactorReduced, bal2025Reduced, amountReduced,
            cumFactorFull, bal2025Full, amountFull
          });
        });

        return {
          totalReducedRate,
          totalFullRate,
          breakdown,
          totalYears: edicYears.length,
          savings: totalFullRate - totalReducedRate
        };
      }, [edicYears, repaymentMonth]);

      const calculations = useMemo(() => {
        const { currentAge, brsJoinDate, currentCityServiceYears, expectedFinalSalary, salaryGrowthRate, lifeExpectancy, departureAge } = inputs;
        const edicServiceYears = edicYears.length;
        const table = brsJoinDate === 'post-2012' ? GROUP1_TABLE_POST_2012 : GROUP1_TABLE_PRE_2012;
        const minRetirementAge = brsJoinDate === 'post-2012' ? 60 : 55;
        const avgYears = brsJoinDate === 'post-2012' ? 5 : 3;
        const MAX_BENEFIT_PERCENT = 80;
        
        // If departure age is set, service and salary freeze at that point
        const willDepart = departureAge && departureAge > currentAge && departureAge < 70;
        const yearsUntilDeparture = willDepart ? departureAge - currentAge : null;
        const frozenServiceYears = willDepart ? currentCityServiceYears + yearsUntilDeparture : null;

        const projectSalary = (yearsFromNow) => expectedFinalSalary * Math.pow(1 + salaryGrowthRate / 100, yearsFromNow);
        
        // Get all EDIC salaries (for buyback years)
        const edicSalaries = edicYears.map(y => y.salary);
        
        // Calculate highest avg salary including EDIC years if buyback
        const getHighestAvgSalary = (retirementAge, includeBuyback) => {
          const yearsUntilRetirement = retirementAge - currentAge;
          const allSalaries = [];
          
          // Add EDIC salaries if buyback is included
          if (includeBuyback && edicSalaries.length > 0) {
            allSalaries.push(...edicSalaries);
          }
          
          // Add City salaries up to retirement or departure
          const maxCityYears = willDepart ? Math.min(yearsUntilRetirement, yearsUntilDeparture) : yearsUntilRetirement;
          for (let i = 0; i <= Math.max(0, maxCityYears); i++) {
            allSalaries.push(projectSalary(i));
          }
          
          // Sort descending and take highest N years
          allSalaries.sort((a, b) => b - a);
          const topYears = allSalaries.slice(0, avgYears);
          return topYears.length > 0 ? topYears.reduce((a, b) => a + b, 0) / topYears.length : 0;
        };
        
        // Calculate frozen salary if departing early (without buyback for comparison)
        const getFrozenHighestAvgSalary = (includeBuyback) => {
          if (!willDepart) return null;
          return getHighestAvgSalary(departureAge, includeBuyback);
        };
        
        const frozenAvgSalary = getFrozenHighestAvgSalary(false);
        const frozenAvgSalaryWithBuyback = getFrozenHighestAvgSalary(true);

        const getBenefitPercent = (age, serviceYears) => {
          const basePercent = table[age] || 0;
          return Math.min(basePercent * serviceYears, MAX_BENEFIT_PERCENT);
        };
        
        const getServiceAtRetirement = (retireAge) => {
          if (willDepart && retireAge >= departureAge) {
            // Service frozen at departure
            return frozenServiceYears;
          }
          const yearsUntilRetirement = retireAge - currentAge;
          return currentCityServiceYears + Math.max(0, yearsUntilRetirement);
        };

        const scenarios = [];
        
        for (let retireAge = 45; retireAge <= 70; retireAge++) {
          const yearsUntilRetirement = retireAge - currentAge;
          const serviceAtRetirement = getServiceAtRetirement(retireAge);
          const serviceWithBuyback = serviceAtRetirement + edicServiceYears;
          
          // Calculate avg salary WITHOUT buyback (only City years)
          const avgSalaryWithout = getHighestAvgSalary(retireAge, false);
          // Calculate avg salary WITH buyback (EDIC + City years)
          const avgSalaryWith = getHighestAvgSalary(retireAge, true);

          const percentWithout = getBenefitPercent(retireAge, serviceAtRetirement);
          const percentWith = getBenefitPercent(retireAge, serviceWithBuyback);
          
          const annualPensionWithout = avgSalaryWithout * (percentWithout / 100);
          const annualPensionWith = avgSalaryWith * (percentWith / 100);
          const annualBenefit = annualPensionWith - annualPensionWithout;

          const yearsCollecting = lifeExpectancy - retireAge;
          const lifetimeBenefitWithout = annualPensionWithout * yearsCollecting;
          const lifetimeBenefitWith = annualPensionWith * yearsCollecting;
          const lifetimeGain = lifetimeBenefitWith - lifetimeBenefitWithout;

          const buybackCost = buybackCalculation.totalReducedRate;
          const buybackCostFull = buybackCalculation.totalFullRate;
          
          const netLifetimeGain = lifetimeGain - buybackCost;
          const roi = buybackCost > 0 ? (netLifetimeGain / buybackCost) * 100 : 0;
          const paybackYears = annualBenefit > 0 ? buybackCost / annualBenefit : Infinity;

          const hitsMaxWithout = percentWithout >= MAX_BENEFIT_PERCENT;
          const hitsMaxWith = percentWith >= MAX_BENEFIT_PERCENT;
          
          // Eligibility checks
          const tooYoung = retireAge < minRetirementAge;
          const alreadyPast = retireAge <= currentAge;
          const notEligible = tooYoung || percentWithout === 0;

          scenarios.push({
            retireAge, yearsUntilRetirement, serviceAtRetirement, serviceWithBuyback, 
            avgSalaryWithout, avgSalaryWith,
            percentWithout, percentWith, annualPensionWithout, annualPensionWith, annualBenefit,
            lifetimeBenefitWithout, lifetimeBenefitWith, lifetimeGain, buybackCost, buybackCostFull,
            netLifetimeGain, roi, paybackYears, hitsMaxWithout, hitsMaxWith, buybackWasted: hitsMaxWithout, yearsCollecting,
            tooYoung, alreadyPast, notEligible, minRetirementAge
          });
        }

        const eligibleScenarios = scenarios.filter(s => !s.notEligible && !s.alreadyPast);
        
        return {
          scenarios,
          optimalWithBuyback: eligibleScenarios.filter(s => !s.buybackWasted).sort((a, b) => b.lifetimeBenefitWith - a.lifetimeBenefitWith)[0],
          optimalWithoutBuyback: [...eligibleScenarios].sort((a, b) => b.lifetimeBenefitWithout - a.lifetimeBenefitWithout)[0],
          bestBuybackROI: eligibleScenarios.filter(s => !s.buybackWasted && s.roi > 0).sort((a, b) => b.roi - a.roi)[0],
          minRetirementAge, avgYears, edicServiceYears,
          willDepart, departureAge: willDepart ? departureAge : null, frozenServiceYears, frozenAvgSalary
        };
      }, [inputs, edicYears, buybackCalculation]);

      const formatCurrency = (num) => {
        if (num >= 1000000) return `$${(num / 1000000).toFixed(2)}M`;
        if (num >= 1000) return `$${(num / 1000).toFixed(0)}K`;
        return `$${num.toFixed(0)}`;
      };

      const formatCurrencyFull = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
      const formatPercent = (num) => `${num.toFixed(1)}%`;

      const generatePDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        let y = 20;

        // Title
        doc.setFontSize(20);
        doc.setTextColor(40, 80, 120);
        doc.text('Boston Retirement System', pageWidth / 2, y, { align: 'center' });
        y += 8;
        doc.setFontSize(16);
        doc.text('Pension Optimization Report', pageWidth / 2, y, { align: 'center' });
        y += 6;
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, y, { align: 'center' });
        y += 15;

        // Personal Information
        doc.setFontSize(14);
        doc.setTextColor(40, 80, 120);
        doc.text('Personal Information', 14, y);
        y += 8;
        doc.setFontSize(10);
        doc.setTextColor(60, 60, 60);
        doc.text(`Current Age: ${inputs.currentAge}`, 14, y);
        doc.text(`BRS Membership: ${inputs.brsJoinDate === 'post-2012' ? 'On/After Apr 2, 2012' : 'Before Apr 2, 2012'}`, 105, y);
        y += 6;
        doc.text(`Current City Service: ${inputs.currentCityServiceYears} years`, 14, y);
        doc.text(`Current Salary: ${formatCurrencyFull(inputs.expectedFinalSalary)}`, 105, y);
        y += 6;
        doc.text(`Expected Salary Growth: ${inputs.salaryGrowthRate}%`, 14, y);
        doc.text(`Life Expectancy: ${inputs.lifeExpectancy}`, 105, y);
        y += 6;
        if (inputs.departureAge) {
          doc.text(`Planned Departure Age: ${inputs.departureAge}`, 14, y);
          y += 6;
        }
        y += 8;

        // EDIC Service History
        if (edicYears.length > 0) {
          doc.setFontSize(14);
          doc.setTextColor(40, 80, 120);
          doc.text('EDIC Service History (Buyback)', 14, y);
          y += 8;

          const edicData = edicYears.map(item => [
            item.year.toString(),
            formatCurrencyFull(item.salary),
            formatCurrencyFull(item.salary * 0.11)
          ]);

          doc.autoTable({
            startY: y,
            head: [['Year', 'Salary', '11% Contribution']],
            body: edicData,
            theme: 'striped',
            headStyles: { fillColor: [40, 80, 120] },
            margin: { left: 14, right: 14 },
            tableWidth: 80
          });

          y = doc.lastAutoTable.finalY + 10;

          // Buyback Cost Summary
          doc.setFontSize(12);
          doc.setTextColor(40, 80, 120);
          doc.text('Buyback Cost Estimate', 14, y);
          y += 6;
          doc.setFontSize(10);
          doc.setTextColor(60, 60, 60);
          doc.text(`Total Years: ${buybackCalculation.totalYears}`, 14, y);
          doc.text(`Repayment: ${MONTH_NAMES[repaymentMonth - 1]} ${repaymentYear}`, 105, y);
          y += 5;
          doc.text(`Cost at 3.45% (Buyback Interest): ${formatCurrencyFull(buybackCalculation.totalReducedRate)}`, 14, y);
          y += 5;
          doc.text(`Cost at 6.9% (Actuarial Interest): ${formatCurrencyFull(buybackCalculation.totalFullRate)}`, 14, y);
          y += 5;
          doc.setTextColor(40, 120, 40);
          doc.text(`Savings with Reduced Rate: ${formatCurrencyFull(buybackCalculation.savings)}`, 14, y);
          y += 12;
        }

        // Recommendation
        if (calculations.optimalWithBuyback) {
          doc.setFontSize(14);
          doc.setTextColor(40, 80, 120);
          doc.text('Recommended Strategy', 14, y);
          y += 8;
          doc.setFontSize(11);
          doc.setTextColor(40, 120, 40);
          doc.text(`Optimal Retirement Age: ${calculations.optimalWithBuyback.retireAge} (with buyback)`, 14, y);
          y += 6;
          doc.setFontSize(10);
          doc.setTextColor(60, 60, 60);
          doc.text(`Total Service: ${calculations.optimalWithBuyback.serviceWithBuyback.toFixed(1)} years`, 14, y);
          doc.text(`Benefit Percentage: ${formatPercent(calculations.optimalWithBuyback.percentWith)}`, 105, y);
          y += 5;
          doc.text(`Annual Pension: ${formatCurrencyFull(calculations.optimalWithBuyback.annualPensionWith)}`, 14, y);
          doc.text(`Lifetime Total: ${formatCurrencyFull(calculations.optimalWithBuyback.lifetimeBenefitWith)}`, 105, y);
          y += 12;
        }

        // Check if we need a new page
        if (y > 200) {
          doc.addPage();
          y = 20;
        }

        // All Scenarios Table
        doc.setFontSize(14);
        doc.setTextColor(40, 80, 120);
        doc.text('All Retirement Scenarios', 14, y);
        y += 8;

        const eligibleScenarios = calculations.scenarios.filter(s => !s.notEligible && !s.alreadyPast);
        const scenarioData = eligibleScenarios.map(s => [
          s.retireAge.toString(),
          s.serviceAtRetirement.toFixed(1),
          s.serviceWithBuyback.toFixed(1),
          formatCurrency(s.avgSalaryWith),
          formatPercent(s.percentWith),
          formatCurrency(s.annualPensionWithout),
          formatCurrency(s.annualPensionWith)
        ]);

        doc.autoTable({
          startY: y,
          head: [['Age', 'Service', 'w/ BB', 'Avg Salary', '% w/ BB', 'Annual (No BB)', 'Annual (w/ BB)']],
          body: scenarioData,
          theme: 'striped',
          headStyles: { fillColor: [40, 80, 120], fontSize: 8 },
          bodyStyles: { fontSize: 8 },
          margin: { left: 14, right: 14 }
        });

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(150, 150, 150);
          doc.text(
            'This is an experiment subject to errors. Do not make any decisions based on its output. Consult Human Resources for official guidance.',
            pageWidth / 2,
            doc.internal.pageSize.getHeight() - 10,
            { align: 'center' }
          );
        }

        doc.save('pension-optimization-report.pdf');
      };

      const styles = {
        container: { minHeight: '100vh', background: 'linear-gradient(135deg, #0a1628 0%, #1a2d4a 50%, #0f1d32 100%)', fontFamily: "'IBM Plex Sans', -apple-system, sans-serif", color: '#e8f0f8', padding: '24px' },
        card: { background: 'linear-gradient(145deg, rgba(30,50,80,0.8), rgba(20,35,60,0.9))', border: '1px solid rgba(100,150,200,0.2)', borderRadius: '16px' },
        highlightCard: { background: 'linear-gradient(145deg, rgba(40,80,120,0.9), rgba(30,60,100,0.95))', border: '1px solid rgba(100,180,240,0.4)', borderRadius: '16px' },
        statValue: { fontFamily: "'IBM Plex Mono', monospace", fontWeight: 500 },
        badge: { display: 'inline-block', padding: '3px 8px', borderRadius: '12px', fontSize: '11px', fontWeight: 600, textTransform: 'uppercase' },
        badgeOptimal: { background: 'linear-gradient(135deg, #2e7d32, #4caf50)', color: 'white' },
        badgeWarning: { background: 'linear-gradient(135deg, #e65100, #ff9800)', color: 'white' },
        badgeMax: { background: 'linear-gradient(135deg, #1565c0, #42a5f5)', color: 'white' },
        toggleBtn: { background: 'rgba(60,100,150,0.3)', border: '1px solid rgba(100,150,200,0.3)', color: '#a0c4e8', padding: '8px 16px', borderRadius: '8px', cursor: 'pointer', fontFamily: 'inherit', fontSize: '14px' },
        toggleBtnActive: { background: 'linear-gradient(135deg, #2a6090, #3a80b0)', borderColor: '#60b0e0', color: 'white' },
        smallBtn: { background: 'rgba(60,100,150,0.3)', border: '1px solid rgba(100,150,200,0.3)', color: '#a0c4e8', padding: '6px 12px', borderRadius: '6px', cursor: 'pointer', fontFamily: 'inherit', fontSize: '12px' },
        applyBtn: { background: 'linear-gradient(135deg, #2e7d32, #4caf50)', border: 'none', color: 'white', padding: '10px 20px', borderRadius: '8px', cursor: 'pointer', fontFamily: 'inherit', fontSize: '14px', fontWeight: '500' }
      };

      return (
        <div style={styles.container}>
          <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
            {/* Header */}
            <header style={{ marginBottom: '32px', textAlign: 'center' }}>
              <div style={{ display: 'inline-block', padding: '6px 16px', background: 'rgba(60,120,180,0.2)', borderRadius: '20px', marginBottom: '12px', fontSize: '12px', letterSpacing: '1.5px', textTransform: 'uppercase', color: '#80b8e8' }}>
                Boston Retirement System â€¢ Group 1
              </div>
              <h1 style={{ fontSize: '36px', fontWeight: '700', margin: '0 0 8px 0', background: 'linear-gradient(135deg, #e8f4ff, #a0d0f0)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                Pension Optimization Tool
              </h1>
              <div style={{ 
                border: '3px solid #ffd700',
                borderRadius: '12px',
                padding: '16px 20px',
                background: 'rgba(255,215,0,0.08)',
                boxShadow: '0 0 20px rgba(255,215,0,0.2)',
                marginTop: '12px'
              }}>
                <p style={{ color: '#8ab4d8', margin: 0, fontSize: '15px' }}>
                  This calculator is an experiment subject to errors. Do not make any decisions based on its output. 
                  Send Ted any ideas for improving this tool! <a 
                    href="#feedback-form" 
                    style={{ 
                      color: '#ffd700', 
                      textDecoration: 'underline',
                      fontWeight: 600
                    }}
                  >
                    Click here
                  </a>.
                </p>
              </div>
            </header>

            {/* EDIC Service History */}
            <div style={{ ...styles.card, padding: '28px', marginBottom: '24px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
                <h2 style={{ fontSize: '18px', fontWeight: '600', margin: 0, color: '#c0daf0', display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <span style={{ width: '28px', height: '28px', background: 'linear-gradient(135deg, #3080b0, #60b0e0)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px' }}>1</span>
                  EDIC Service History
                </h2>
                
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button style={{ ...styles.smallBtn, ...(entryMode === 'manual' ? styles.toggleBtnActive : {}) }} onClick={() => setEntryMode('manual')}>Enter Manually</button>
                  <button style={{ ...styles.smallBtn, ...(entryMode === 'quickfill' ? styles.toggleBtnActive : {}) }} onClick={() => setEntryMode('quickfill')}>Quick Fill</button>
                  {edicYears.length > 0 && <button style={styles.smallBtn} onClick={clearAll}>Clear All</button>}
                </div>
              </div>

              {entryMode === 'quickfill' ? (
                <div style={{ padding: '20px', background: 'rgba(40,80,120,0.3)', borderRadius: '12px', marginBottom: '16px' }}>
                  <p style={{ color: '#a0c4e8', fontSize: '14px', margin: '0 0 16px 0' }}>
                    Enter your start year, end year, starting salary, and average annual raise. We'll calculate each year for you.
                  </p>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '16px', marginBottom: '16px' }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#80a8c8', fontSize: '12px' }}>Start Year</label>
                      <input type="number" value={quickFill.startYear} onChange={(e) => setQuickFill({ ...quickFill, startYear: parseInt(e.target.value) || 2020 })} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#80a8c8', fontSize: '12px' }}>End Year</label>
                      <input type="number" value={quickFill.endYear} onChange={(e) => setQuickFill({ ...quickFill, endYear: parseInt(e.target.value) || 2024 })} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#80a8c8', fontSize: '12px' }}>Starting Salary</label>
                      <input type="number" value={quickFill.startingSalary} onChange={(e) => setQuickFill({ ...quickFill, startingSalary: parseFloat(e.target.value) || 80000 })} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#80a8c8', fontSize: '12px' }}>Annual Raise %</label>
                      <input type="number" step="0.5" value={quickFill.annualRaise} onChange={(e) => setQuickFill({ ...quickFill, annualRaise: parseFloat(e.target.value) || 3 })} />
                    </div>
                  </div>
                  
                  <button style={styles.applyBtn} onClick={applyQuickFill}>Generate Years</button>
                </div>
              ) : (
                <div>
                  <div style={{ display: 'grid', gridTemplateColumns: '100px 1fr 40px', gap: '8px', padding: '0 0 8px 0', borderBottom: '1px solid rgba(100,150,200,0.2)', marginBottom: '8px' }}>
                    <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600' }}>Year</div>
                    <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600' }}>Salary</div>
                    <div></div>
                  </div>

                  {edicYears.map((item, index) => (
                    <div key={`${item.year}-${index}`} className="entry-row">
                      <input type="number" value={item.year} onChange={(e) => updateEdicYear(index, 'year', e.target.value)} className="compact" />
                      <input type="number" value={item.salary} onChange={(e) => updateEdicYear(index, 'salary', e.target.value)} className="compact" />
                      <button className="remove-btn" onClick={() => removeEdicYear(index)}>Ã—</button>
                    </div>
                  ))}

                  <div className="entry-row empty-row">
                    <input ref={yearInputRef} type="number" placeholder="Year" value={newYear} onChange={(e) => setNewYear(e.target.value)} onKeyDown={handleYearKeyDown} className="compact" />
                    <input ref={salaryInputRef} type="number" placeholder="Salary â€” press Enter to add" value={newSalary} onChange={(e) => setNewSalary(e.target.value)} onKeyDown={handleSalaryKeyDown} className="compact" />
                    <div></div>
                  </div>
                  
                  <p style={{ color: '#607890', fontSize: '12px', margin: '12px 0 0 0' }}>
                    Type a year and salary, then press Enter to add.
                  </p>
                </div>
              )}

              {edicYears.length > 0 && (
                <div style={{ marginTop: '24px', padding: '20px', background: 'rgba(40,80,120,0.4)', borderRadius: '12px', border: '1px solid rgba(100,180,240,0.3)' }}>
                  <h3 style={{ margin: '0 0 16px 0', color: '#c0daf0', fontSize: '16px' }}>Buyback Cost Estimate</h3>
                  
                  <div style={{ 
                    display: 'flex', gap: '16px', alignItems: 'flex-end', flexWrap: 'wrap',
                    marginBottom: '20px', padding: '16px', 
                    background: 'rgba(20,40,70,0.5)', borderRadius: '10px',
                    border: '1px solid rgba(100,150,200,0.2)'
                  }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#90b8d8', fontSize: '12px', fontWeight: '500' }}>
                        Planned lump-sum payment month
                      </label>
                      <div style={{ display: 'flex', gap: '10px' }}>
                        <select 
                          value={repaymentMonth} 
                          onChange={(e) => setRepaymentMonth(parseInt(e.target.value))}
                          style={{
                            background: 'rgba(20,40,70,0.8)',
                            border: '1px solid rgba(100,150,200,0.3)',
                            borderRadius: '8px',
                            padding: '8px 12px',
                            color: '#e0f0ff',
                            fontFamily: "'IBM Plex Sans', sans-serif",
                            fontSize: '14px',
                            outline: 'none',
                            cursor: 'pointer'
                          }}
                        >
                          {MONTH_NAMES.map((m, i) => <option key={i} value={i + 1}>{m}</option>)}
                        </select>
                        <span style={{ 
                          padding: '8px 12px', color: '#a0c4e8', fontSize: '14px',
                          background: 'rgba(20,40,70,0.8)', borderRadius: '8px',
                          border: '1px solid rgba(100,150,200,0.2)'
                        }}>2026</span>
                      </div>
                    </div>
                    <div style={{ color: '#607890', fontSize: '12px', lineHeight: '1.4', maxWidth: '320px' }}>
                      Interest accrues monthly â€” paying earlier in the year saves money. Uses official BRS cumulative factor tables.
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '20px' }}>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Years of Service</div>
                      <div style={{ ...styles.statValue, fontSize: '28px', color: '#e0f0ff' }}>{buybackCalculation.totalYears}</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Cost at 3.45%</div>
                      <div style={{ ...styles.statValue, fontSize: '28px', color: '#60d080' }}>{formatCurrencyFull(buybackCalculation.totalReducedRate)}</div>
                      <div style={{ color: '#60a080', fontSize: '11px' }}>Buyback interest (apply by Nov 2026)</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Cost at 6.9%</div>
                      <div style={{ ...styles.statValue, fontSize: '28px', color: '#f0a060' }}>{formatCurrencyFull(buybackCalculation.totalFullRate)}</div>
                      <div style={{ color: '#a08060', fontSize: '11px' }}>Actuarial interest</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>You Save</div>
                      <div style={{ ...styles.statValue, fontSize: '28px', color: '#60d080' }}>{formatCurrencyFull(buybackCalculation.savings)}</div>
                      <div style={{ color: '#60a080', fontSize: '11px' }}>With buyback interest rate</div>
                    </div>
                  </div>

                  <details style={{ marginTop: '20px' }}>
                    <summary style={{ color: '#90b8d8', cursor: 'pointer', fontSize: '14px' }}>View year-by-year breakdown</summary>
                    <table style={{ width: '100%', marginTop: '12px', fontSize: '13px', borderCollapse: 'collapse' }}>
                      <thead>
                        <tr style={{ borderBottom: '1px solid rgba(100,150,200,0.3)' }}>
                          <th style={{ padding: '8px', textAlign: 'left', color: '#80a8c8' }}>Year</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>Salary</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>11%</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>Factor</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>@ 3.45%</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>@ 6.9%</th>
                        </tr>
                      </thead>
                      <tbody>
                        {buybackCalculation.breakdown.map((row, i) => (
                          <tr key={i} style={{ borderBottom: '1px solid rgba(100,150,200,0.1)' }}>
                            <td style={{ padding: '8px' }}>{row.year}</td>
                            <td style={{ padding: '8px', textAlign: 'right', ...styles.statValue }}>{formatCurrencyFull(row.salary)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', ...styles.statValue }}>{formatCurrencyFull(row.contribution)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', color: '#90b8d8', fontSize: '12px' }}>{row.cumFactorReduced.toFixed(4)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', ...styles.statValue, color: '#60d080' }}>{formatCurrencyFull(row.amountReduced)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', ...styles.statValue, color: '#f0a060' }}>{formatCurrencyFull(row.amountFull)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <p style={{ color: '#607890', fontSize: '11px', margin: '8px 0 0 0' }}>
                      Factor = BRS cumulative interest to 12/31/2025. Totals include {MONTH_NAMES[repaymentMonth - 1]} 2026 partial-year interest.
                    </p>
                  </details>
                </div>
              )}
            </div>

            {/* Personal Info */}
            <div style={{ ...styles.card, padding: '28px', marginBottom: '24px' }}>
              <h2 style={{ fontSize: '18px', fontWeight: '600', margin: '0 0 24px 0', color: '#c0daf0', display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ width: '28px', height: '28px', background: 'linear-gradient(135deg, #3080b0, #60b0e0)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px' }}>2</span>
                Your Information
              </h2>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '24px' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Current Age</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="25" max="65" value={inputs.currentAge} onChange={(e) => handleInputChange('currentAge', parseInt(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '50px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{inputs.currentAge}</span>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>BRS Membership Date</label>
                  <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    <button style={{ ...styles.toggleBtn, ...(inputs.brsJoinDate === 'post-2012' ? styles.toggleBtnActive : {}) }} onClick={() => handleInputChange('brsJoinDate', 'post-2012')}>On/After Apr 2, 2012</button>
                    <button style={{ ...styles.toggleBtn, ...(inputs.brsJoinDate === 'pre-2012' ? styles.toggleBtnActive : {}) }} onClick={() => handleInputChange('brsJoinDate', 'pre-2012')}>Before Apr 2, 2012</button>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Current City Service (Years in BRS)</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="0" max="30" step="0.5" value={inputs.currentCityServiceYears} onChange={(e) => handleInputChange('currentCityServiceYears', parseFloat(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '50px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{inputs.currentCityServiceYears}</span>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Current Annual Salary</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="40000" max="250000" step="1000" value={inputs.expectedFinalSalary} onChange={(e) => handleInputChange('expectedFinalSalary', parseInt(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '80px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{formatCurrency(inputs.expectedFinalSalary)}</span>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Expected Annual Salary Growth</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="0" max="6" step="0.5" value={inputs.salaryGrowthRate} onChange={(e) => handleInputChange('salaryGrowthRate', parseFloat(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '50px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{inputs.salaryGrowthRate}%</span>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Life Expectancy</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="70" max="100" value={inputs.lifeExpectancy} onChange={(e) => handleInputChange('lifeExpectancy', parseInt(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '50px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{inputs.lifeExpectancy}</span>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>
                    Planned Departure Age <span style={{ color: '#607890', fontWeight: '400' }}>(optional â€” leave blank if working until retirement)</span>
                  </label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <input 
                      type="number" 
                      placeholder="e.g. 55" 
                      value={inputs.departureAge || ''} 
                      onChange={(e) => handleInputChange('departureAge', e.target.value ? parseInt(e.target.value) : null)}
                      style={{ maxWidth: '120px' }}
                      className="compact"
                    />
                    {inputs.departureAge && (
                      <button 
                        style={{ ...styles.smallBtn, padding: '6px 10px' }} 
                        onClick={() => handleInputChange('departureAge', null)}
                      >
                        Clear
                      </button>
                    )}
                    {inputs.departureAge && inputs.departureAge > inputs.currentAge && (
                      <span style={{ color: '#80a8c8', fontSize: '13px' }}>
                        Service & salary freeze at age {inputs.departureAge}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Departure Notice */}
            {calculations.willDepart && (
              <div style={{ ...styles.card, padding: '20px', marginBottom: '24px', background: 'linear-gradient(145deg, rgba(80,60,30,0.6), rgba(60,45,20,0.7))', border: '1px solid rgba(200,150,80,0.3)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                  <span style={{ fontSize: '20px' }}>ðŸ“‹</span>
                  <div>
                    <div style={{ color: '#e0c080', fontWeight: '600', marginBottom: '4px' }}>Early Departure at Age {calculations.departureAge}</div>
                    <div style={{ color: '#b0a080', fontSize: '13px' }}>
                      Service freezes at {calculations.frozenServiceYears?.toFixed(1)} years â€¢ 
                      Salary freezes at {formatCurrency(calculations.frozenAvgSalary)} avg â€¢ 
                      Pension starts at age {calculations.minRetirementAge}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Key Insights */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px', marginBottom: '24px' }}>
              {calculations.optimalWithBuyback && (
                <div style={{ ...styles.highlightCard, padding: '24px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                    <span style={{ color: '#80c0e8', fontSize: '13px', fontWeight: '500', textTransform: 'uppercase' }}>Best with Buyback</span>
                    <span style={{ ...styles.badge, ...styles.badgeOptimal }}>Recommended</span>
                  </div>
                  <div style={{ ...styles.statValue, fontSize: '42px', color: '#e0f8ff', marginBottom: '8px' }}>Age {calculations.optimalWithBuyback.retireAge}</div>
                  <div style={{ color: '#a0d0f0', fontSize: '14px', marginBottom: '16px' }}>{calculations.optimalWithBuyback.serviceWithBuyback.toFixed(1)} years service â€¢ {formatPercent(calculations.optimalWithBuyback.percentWith)} of salary</div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', paddingTop: '16px', borderTop: '1px solid rgba(100,150,200,0.2)' }}>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Annual Pension</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: '#60d060' }}>{formatCurrency(calculations.optimalWithBuyback.annualPensionWith)}</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Lifetime Total</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: '#60d060' }}>{formatCurrency(calculations.optimalWithBuyback.lifetimeBenefitWith)}</div>
                    </div>
                  </div>
                </div>
              )}

              {calculations.bestBuybackROI && edicYears.length > 0 && (
                <div style={{ ...styles.card, padding: '24px' }}>
                  <div style={{ color: '#80c0e8', fontSize: '13px', fontWeight: '500', textTransform: 'uppercase', marginBottom: '16px' }}>Buyback Investment</div>
                  <div style={{ ...styles.statValue, fontSize: '42px', color: '#f0c060', marginBottom: '8px' }}>{formatCurrency(calculations.bestBuybackROI.buybackCost)}</div>
                  <div style={{ color: '#a0d0f0', fontSize: '14px', marginBottom: '16px' }}>Cost at 3.45% rate</div>
                  <div style={{ paddingTop: '16px', borderTop: '1px solid rgba(100,150,200,0.2)' }}>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Lifetime ROI</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: calculations.bestBuybackROI.roi > 0 ? '#60d060' : '#e06060' }}>{formatPercent(calculations.bestBuybackROI.roi)}</div>
                    </div>
                  </div>
                </div>
              )}

              {calculations.optimalWithoutBuyback && (
                <div style={{ ...styles.card, padding: '24px' }}>
                  <div style={{ color: '#80c0e8', fontSize: '13px', fontWeight: '500', textTransform: 'uppercase', marginBottom: '16px' }}>Without Buyback</div>
                  <div style={{ ...styles.statValue, fontSize: '42px', color: '#c0d8e8', marginBottom: '8px' }}>Age {calculations.optimalWithoutBuyback.retireAge}</div>
                  <div style={{ color: '#a0d0f0', fontSize: '14px', marginBottom: '16px' }}>{calculations.optimalWithoutBuyback.serviceAtRetirement.toFixed(1)} years service â€¢ {formatPercent(calculations.optimalWithoutBuyback.percentWithout)} of salary</div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', paddingTop: '16px', borderTop: '1px solid rgba(100,150,200,0.2)' }}>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Annual Pension</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: '#a0c8e0' }}>{formatCurrency(calculations.optimalWithoutBuyback.annualPensionWithout)}</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Lifetime Total</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: '#a0c8e0' }}>{formatCurrency(calculations.optimalWithoutBuyback.lifetimeBenefitWithout)}</div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Scenario Table */}
            <div style={{ ...styles.card, padding: '28px', marginBottom: '24px' }}>
              <h2 style={{ fontSize: '18px', fontWeight: '600', margin: '0 0 20px 0', color: '#c0daf0', display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ width: '28px', height: '28px', background: 'linear-gradient(135deg, #3080b0, #60b0e0)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px' }}>3</span>
                All Retirement Scenarios
              </h2>

              <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid rgba(100,150,200,0.3)' }}>
                      {['Retire Age', 'Service', 'w/ Buyback', 'Avg Salary', 'Avg w/ BB', '% (No BB)', '% (w/ BB)', 'Annual (No BB)', 'Annual (w/ BB)', 'Status'].map((h) => (
                        <th key={h} style={{ padding: '12px 8px', textAlign: h === 'Status' ? 'center' : (h === 'Retire Age' ? 'left' : 'right'), color: '#80a8c8', fontWeight: '600', fontSize: '11px', textTransform: 'uppercase' }}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {calculations.scenarios.filter(s => !s.notEligible && !s.alreadyPast).map((s) => {
                      const isOptimal = calculations.optimalWithBuyback?.retireAge === s.retireAge;
                      const isSelected = selectedScenario === s.retireAge;
                      return (
                        <tr key={s.retireAge} className="scenario-row" onClick={() => setSelectedScenario(isSelected ? null : s.retireAge)}
                          style={{ borderBottom: '1px solid rgba(100,150,200,0.1)', background: isSelected ? 'rgba(60,140,200,0.25)' : (isOptimal ? 'rgba(60,160,100,0.1)' : undefined), borderLeft: isSelected ? '3px solid #60b0e0' : '3px solid transparent', cursor: 'pointer' }}>
                          <td style={{ padding: '14px 8px', fontWeight: isOptimal ? '600' : '400' }}>
                            {s.retireAge}
                            {isOptimal && <span style={{ ...styles.badge, ...styles.badgeOptimal, marginLeft: '8px' }}>Best</span>}
                          </td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right' }}>{s.serviceAtRetirement.toFixed(1)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right', color: '#80c8e8' }}>{s.serviceWithBuyback.toFixed(1)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right' }}>{formatCurrency(s.avgSalaryWithout)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right', color: '#80c8e8' }}>{formatCurrency(s.avgSalaryWith)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right' }}>{formatPercent(s.percentWithout)}{s.hitsMaxWithout && <span style={{ marginLeft: '4px', color: '#60a0e0' }}>â˜…</span>}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right', color: '#80c8e8' }}>{formatPercent(s.percentWith)}{s.hitsMaxWith && <span style={{ marginLeft: '4px', color: '#60a0e0' }}>â˜…</span>}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right' }}>{formatCurrency(s.annualPensionWithout)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right', color: '#60d080' }}>{formatCurrency(s.annualPensionWith)}</td>
                          <td style={{ padding: '14px 8px', textAlign: 'center' }}>
                            {s.buybackWasted ? <span style={{ ...styles.badge, ...styles.badgeWarning }}>BB Wasted</span> : s.hitsMaxWith ? <span style={{ ...styles.badge, ...styles.badgeMax }}>Max 80%</span> : null}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              <div style={{ marginTop: '16px', fontSize: '12px', color: '#80a8c8' }}>â˜… = Hits 80% max | BB = Buyback | Click row for details</div>
              
              <div style={{ marginTop: '24px', paddingTop: '20px', borderTop: '1px solid rgba(100,150,200,0.2)', textAlign: 'center' }}>
                <button 
                  onClick={generatePDF}
                  style={{ 
                    background: 'linear-gradient(135deg, #2e7d32, #4caf50)', 
                    border: 'none', 
                    color: 'white', 
                    padding: '14px 28px', 
                    borderRadius: '10px', 
                    cursor: 'pointer', 
                    fontFamily: 'inherit', 
                    fontSize: '15px', 
                    fontWeight: '600',
                    display: 'inline-flex',
                    alignItems: 'center',
                    gap: '10px',
                    boxShadow: '0 4px 12px rgba(46, 125, 50, 0.3)'
                  }}
                >
                  <span style={{ fontSize: '18px' }}>ðŸ“„</span>
                  Download PDF Report
                </button>
                <p style={{ color: '#607890', fontSize: '12px', marginTop: '10px' }}>
                  Generate a downloadable report with all your pension scenarios
                </p>
              </div>
            </div>

            {/* Selected Scenario Detail */}
            {selectedScenario && (() => {
              const s = calculations.scenarios.find(sc => sc.retireAge === selectedScenario);
              if (!s) return null;
              return (
                <div style={{ ...styles.highlightCard, padding: '28px', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '18px', fontWeight: '600', margin: '0 0 20px 0', color: '#c0daf0' }}>Detailed Analysis: Retire at Age {s.retireAge}</h2>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px' }}>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Years Until Retirement</div><div style={{ ...styles.statValue, fontSize: '24px' }}>{s.yearsUntilRetirement}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Years Collecting</div><div style={{ ...styles.statValue, fontSize: '24px' }}>{s.yearsCollecting}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Highest {calculations.avgYears}-Yr Avg (No BB)</div><div style={{ ...styles.statValue, fontSize: '24px' }}>{formatCurrency(s.avgSalaryWithout)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Highest {calculations.avgYears}-Yr Avg (w/ BB)</div><div style={{ ...styles.statValue, fontSize: '24px', color: '#80c8e8' }}>{formatCurrency(s.avgSalaryWith)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Buyback Cost (3.45%)</div><div style={{ ...styles.statValue, fontSize: '24px', color: '#60d080' }}>{formatCurrencyFull(s.buybackCost)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Buyback Cost (6.9%)</div><div style={{ ...styles.statValue, fontSize: '24px', color: '#f0a060' }}>{formatCurrencyFull(s.buybackCostFull)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Annual Benefit from BB</div><div style={{ ...styles.statValue, fontSize: '24px', color: s.annualBenefit > 0 ? '#60d080' : '#a0a0a0' }}>+{formatCurrency(s.annualBenefit)}/yr</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Lifetime Gain from BB</div><div style={{ ...styles.statValue, fontSize: '24px', color: s.lifetimeGain > 0 ? '#60d080' : '#a0a0a0' }}>{formatCurrency(s.lifetimeGain)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Net Gain (After Cost)</div><div style={{ ...styles.statValue, fontSize: '24px', color: s.netLifetimeGain > 0 ? '#60d080' : '#e06060' }}>{formatCurrency(s.netLifetimeGain)}</div></div>
                  </div>
                  {s.buybackWasted && (
                    <div style={{ marginTop: '20px', padding: '16px', background: 'rgba(230,100,50,0.15)', borderRadius: '12px', border: '1px solid rgba(230,100,50,0.3)' }}>
                      <strong style={{ color: '#f0a060' }}>âš ï¸ Buyback Warning:</strong>
                      <span style={{ color: '#d0c0a0', marginLeft: '8px' }}>You would already hit the 80% max without buyback. Buying back EDIC service would not increase your pension.</span>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Feedback Form */}
            <div 
              id="feedback-form"
              style={{
                ...styles.card,
                padding: '28px',
                marginBottom: '24px',
                background: 'linear-gradient(145deg, rgba(40,70,100,0.4), rgba(30,60,90,0.5))',
                border: '1px solid rgba(100,150,200,0.3)'
              }}
            >
              <h2 style={{ 
                fontSize: '18px', 
                fontWeight: '600', 
                margin: '0 0 8px 0', 
                color: '#c0daf0' 
              }}>
                Send Feedback to Ted
              </h2>
              <p style={{
                fontSize: '14px',
                color: '#8ab4d8',
                marginBottom: '20px',
                lineHeight: '1.5'
              }}>
                Questions about the calculator? Found a bug? Have suggestions for improvement?
              </p>
              
              <form 
                action="https://formspree.io/f/mreagbzk" 
                method="POST"
                style={{ maxWidth: '600px' }}
              >
                <div style={{ marginBottom: '16px' }}>
                  <label style={{ 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: 500,
                    color: '#a0c8e8',
                    fontSize: '14px'
                  }}>
                    Your Email:
                  </label>
                  <input 
                    type="email" 
                    name="email" 
                    required
                    style={{
                      width: '100%',
                      padding: '12px',
                      fontSize: '15px',
                      background: 'rgba(20,40,70,0.6)',
                      border: '1px solid rgba(100,150,200,0.3)',
                      borderRadius: '8px',
                      color: '#e0f0ff',
                      fontFamily: 'IBM Plex Sans, sans-serif',
                      outline: 'none'
                    }}
                  />
                </div>
                
                <div style={{ marginBottom: '16px' }}>
                  <label style={{ 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: 500,
                    color: '#a0c8e8',
                    fontSize: '14px'
                  }}>
                    Message:
                  </label>
                  <textarea 
                    name="message" 
                    rows="5" 
                    required
                    placeholder="Describe your question, bug report, or suggestion..."
                    style={{
                      width: '100%',
                      padding: '12px',
                      fontSize: '15px',
                      background: 'rgba(20,40,70,0.6)',
                      border: '1px solid rgba(100,150,200,0.3)',
                      borderRadius: '8px',
                      color: '#e0f0ff',
                      fontFamily: 'IBM Plex Sans, sans-serif',
                      outline: 'none',
                      resize: 'vertical'
                    }}
                  />
                </div>
                
                <button 
                  type="submit"
                  style={{
                    padding: '12px 24px',
                    fontSize: '15px',
                    fontWeight: 600,
                    color: 'white',
                    background: 'linear-gradient(135deg, #3080b0, #60b0e0)',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontFamily: 'IBM Plex Sans, sans-serif',
                    boxShadow: '0 4px 12px rgba(60,176,224,0.3)'
                  }}
                >
                  Send Message
                </button>
              </form>
            </div>

            {/* Footer */}
            <div style={{ textAlign: 'center', padding: '24px', color: '#607890', fontSize: '12px', borderTop: '1px solid rgba(100,150,200,0.1)' }}>
              <p style={{ margin: 0 }}>This is an experiment subject to errors. Do not make any decisions based on its output. Consult Human Resources for official guidance.</p>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
