<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BRS Pension Optimizer</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KP9WD9PCKQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KP9WD9PCKQ');
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #0a1628; }
    
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(90deg, #2a5a8a, #4a9aca);
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60b0e0, #3090c0);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    input[type="number"] {
      background: rgba(20,40,70,0.8);
      border: 1px solid rgba(100,150,200,0.3);
      border-radius: 8px;
      padding: 10px 14px;
      color: #e0f0ff;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 15px;
      width: 100%;
      outline: none;
    }
    
    input[type="number"]:focus {
      border-color: #60b0e0;
    }

    input[type="number"].compact {
      padding: 8px 10px;
      font-size: 14px;
    }
    
    .scenario-row:hover {
      background: rgba(60,120,180,0.15);
    }

    .entry-row {
      display: grid;
      grid-template-columns: 100px 1fr 40px;
      gap: 8px;
      align-items: center;
      padding: 6px 0;
    }

    .remove-btn {
      background: transparent;
      border: none;
      color: #a08080;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .remove-btn:hover {
      background: rgba(200,80,80,0.2);
      color: #f08080;
    }

    .empty-row input {
      border-style: dashed;
      background: rgba(20,40,70,0.4);
    }

    .empty-row input::placeholder {
      color: #506880;
    }

    select {
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2380a8c8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px !important;
    }

    select option {
      background: #1a2d4a;
      color: #e0f0ff;
    }
  </style>
</head>
<body>
   <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useMemo, useRef } = React;

    const GROUP1_TABLE_POST_2012 = {
      60: 1.45, 61: 1.6, 62: 1.75, 63: 1.9, 64: 2.05, 65: 2.2, 66: 2.35, 67: 2.5,
      68: 2.5, 69: 2.5, 70: 2.5, 71: 2.5, 72: 2.5, 73: 2.5, 74: 2.5
    };



    // BRS contribution: 9% of salary + 2% of salary over $30,000
    const CONTRIBUTION_THRESHOLD = 30000;
    const calcContribution = (salary) => 0.09 * salary + 0.02 * Math.max(0, salary - CONTRIBUTION_THRESHOLD);

    // Official BRS cumulative interest factors to 12/31/2025
    // Derived from 2025 BRS worksheet by applying one additional year of compounding
    // Buyback Interest at 6.90% = annual compound rate of 3.45% (rate ÷ 2)
    const BUYBACK_CUM_FACTORS = {
      1977: 5.094057, 1978: 4.924172, 1979: 4.759954, 1980: 4.601212,
      1981: 4.447764, 1982: 4.299434, 1983: 4.156050, 1984: 4.017449,
      1985: 3.883469, 1986: 3.753957, 1987: 3.628764, 1988: 3.507747,
      1989: 3.390766, 1990: 3.277686, 1991: 3.168377, 1992: 3.062713,
      1993: 2.960573, 1994: 2.861840, 1995: 2.766399, 1996: 2.674141,
      1997: 2.584960, 1998: 2.498753, 1999: 2.415421, 2000: 2.334869,
      2001: 2.257002, 2002: 2.181732, 2003: 2.108972, 2004: 2.038639,
      2005: 1.970652, 2006: 1.904931, 2007: 1.841403, 2008: 1.779994,
      2009: 1.720632, 2010: 1.663249, 2011: 1.607782, 2012: 1.554162,
      2013: 1.502332, 2014: 1.452230, 2015: 1.403799, 2016: 1.356984,
      2017: 1.311728, 2018: 1.267984, 2019: 1.225696, 2020: 1.184820,
      2021: 1.145307, 2022: 1.107112, 2023: 1.070190, 2024: 1.034500,
      2025: 1.000000
    };

    // Actuarial Interest at 6.90% = annual compound rate of 6.90% (full rate)
    const ACTUARIAL_CUM_FACTORS = {
      1977: 24.599702, 1978: 23.011882, 1979: 21.526550, 1980: 20.137091,
      1981: 18.837316, 1982: 17.621437, 1983: 16.484039, 1984: 15.420055,
      1985: 14.424747, 1986: 13.493683, 1987: 12.622716, 1988: 11.807966,
      1989: 11.045805, 1990: 10.332840, 1991: 9.665893, 1992: 9.041995,
      1993: 8.458367, 1994: 7.912412, 1995: 7.401694, 1996: 6.923943,
      1997: 6.477027, 1998: 6.058959, 1999: 5.667875, 2000: 5.302036,
      2001: 4.959808, 2002: 4.639672, 2003: 4.340198, 2004: 4.060055,
      2005: 3.797992, 2006: 3.552846, 2007: 3.323523, 2008: 3.109002,
      2009: 2.908328, 2010: 2.720606, 2011: 2.545000, 2012: 2.380730,
      2013: 2.227063, 2014: 2.083314, 2015: 1.948844, 2016: 1.823053,
      2017: 1.705382, 2018: 1.595306, 2019: 1.492335, 2020: 1.396010,
      2021: 1.305903, 2022: 1.221612, 2023: 1.142761, 2024: 1.069000,
      2025: 1.000000
    };

    // Monthly interest rates for partial-year 2026 calculation
    const BUYBACK_MONTHLY_RATE = 0.002875;   // 6.90% / 200 / 12
    const ACTUARIAL_MONTHLY_RATE = 0.005750;  // 6.90% / 100 / 12

    const MONTH_NAMES = ['January','February','March','April','May','June',
      'July','August','September','October','November','December'];

    function App() {
      const [inputs, setInputs] = useState({
        currentAge: 45,
        expectedFinalSalary: 120000,
        salaryGrowthRate: 2.5,
        lifeExpectancy: 85,
        departureAge: null
      });
      
      const [edicYears, setEdicYears] = useState([]);
      const [entryMode, setEntryMode] = useState('manual');
      const [repaymentMonth, setRepaymentMonth] = useState(new Date().getMonth() + 1);
      const [repaymentYear] = useState(2026);
      
      const [quickFill, setQuickFill] = useState({
        startYear: 2020,
        endYear: 2024,
        startingSalary: 80000,
        annualRaise: 3
      });

      const [newYear, setNewYear] = useState('');
      const [newSalary, setNewSalary] = useState('');
      const [pasteText, setPasteText] = useState('');
      const [pastePreview, setPastePreview] = useState(null);
      const [pasteError, setPasteError] = useState('');
      const salaryInputRef = useRef(null);
      const yearInputRef = useRef(null);
      
      const [selectedScenario, setSelectedScenario] = useState(null);

      const handleInputChange = (field, value) => {
        setInputs(prev => ({ ...prev, [field]: value }));
      };

      const addEntry = () => {
        const year = parseInt(newYear);
        const salary = parseFloat(newSalary);
        if (year && salary && year >= 1980 && year <= 2030 && salary > 0) {
          const updated = [...edicYears, { year, salary }].sort((a, b) => a.year - b.year);
          setEdicYears(updated);
          setNewYear('');
          setNewSalary('');
          setTimeout(() => yearInputRef.current?.focus(), 50);
        }
      };

      const handleYearKeyDown = (e) => {
        if (e.key === 'Enter' || e.key === 'Tab') {
          if (newYear && salaryInputRef.current) {
            e.preventDefault();
            salaryInputRef.current.focus();
          }
        }
      };

      const handleSalaryKeyDown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addEntry();
        }
      };

      const removeEdicYear = (index) => {
        setEdicYears(edicYears.filter((_, i) => i !== index));
      };

      const updateEdicYear = (index, field, value) => {
        const updated = [...edicYears];
        updated[index][field] = field === 'year' ? parseInt(value) || 0 : parseFloat(value) || 0;
        updated.sort((a, b) => a.year - b.year);
        setEdicYears(updated);
      };

      const applyQuickFill = () => {
        const { startYear, endYear, startingSalary, annualRaise } = quickFill;
        const years = [];
        for (let y = startYear; y <= endYear; y++) {
          const yearsFromStart = y - startYear;
          const salary = Math.round(startingSalary * Math.pow(1 + annualRaise / 100, yearsFromStart));
          years.push({ year: y, salary });
        }
        setEdicYears(years);
        setEntryMode('manual');
      };

      const clearAll = () => {
        setEdicYears([]);
        setNewYear('');
        setNewSalary('');
      };

      const parsePastedData = (text) => {
        setPasteText(text);
        setPasteError('');
        setPastePreview(null);
        if (!text.trim()) return;

        const lines = text.trim().split('\n').filter(l => l.trim());
        const parsed = [];
        const errors = [];

        lines.forEach((line, i) => {
          // Detect delimiter: tabs first (Excel/Sheets default), then pipe, then comma (but not thousands separators), then multi-space
          const raw = line.trim();
          let parts;
          if (raw.includes('\t')) {
            parts = raw.split(/\t+/);
          } else if (raw.includes('|')) {
            parts = raw.split(/\|+/);
          } else if (/,\s*[^0-9]/.test(raw) || /,[0-9]{1,2}(?!\d)/.test(raw) || (raw.match(/,/g) || []).length === 1 && !/,\d{3}/.test(raw)) {
            // Comma is likely a delimiter (not a thousands separator like 85,000)
            parts = raw.split(/,/);
          } else if (/\s{2,}/.test(raw)) {
            parts = raw.split(/\s{2,}/);
          } else {
            // Single-space separated as last resort
            parts = raw.split(/\s+/);
          }
          parts = parts.map(s => s.trim().replace(/[$,]/g, ''));
          
          if (parts.length < 2) {
            errors.push(`Row ${i + 1}: Need at least 2 columns (year and salary)`);
            return;
          }

          const year = parseInt(parts[0]);
          const salary = parseFloat(parts[1]);

          // Skip header rows
          if (isNaN(year) || isNaN(salary)) {
            if (i === 0 && (parts[0].toLowerCase().includes('year') || parts[0].toLowerCase().includes('date'))) {
              return; // Skip header
            }
            errors.push(`Row ${i + 1}: Could not parse "${line.trim()}"`);
            return;
          }

          if (year < 1977 || year > 2030) {
            errors.push(`Row ${i + 1}: Year ${year} is out of range (1977–2030)`);
            return;
          }

          if (salary <= 0) {
            errors.push(`Row ${i + 1}: Salary must be positive`);
            return;
          }

          parsed.push({ year, salary: Math.round(salary) });
        });

        if (parsed.length > 0) {
          parsed.sort((a, b) => a.year - b.year);
          setPastePreview(parsed);
        }
        if (errors.length > 0) {
          setPasteError(errors.join('\n'));
        }
      };

      const applyPastedData = () => {
        if (pastePreview && pastePreview.length > 0) {
          setEdicYears(pastePreview);
          setPasteText('');
          setPastePreview(null);
          setPasteError('');
          setEntryMode('manual');
        }
      };

      const buybackCalculation = useMemo(() => {
        let totalReducedRate = 0;
        let totalFullRate = 0;
        const breakdown = [];

        edicYears.forEach(({ year, salary }) => {
          const contribution = calcContribution(salary);
          
          // Official BRS worksheet method:
          // 1. contribution × cumulative factor = balance at 12/31/2025
          // 2. balance × (month × monthly rate) = partial 2026 interest
          // 3. total = balance + partial year interest
          
          const cumFactorReduced = BUYBACK_CUM_FACTORS[year] || Math.pow(1.0345, 2025 - year);
          const bal2025Reduced = contribution * cumFactorReduced;
          const partialReduced = bal2025Reduced * (repaymentMonth * BUYBACK_MONTHLY_RATE);
          const amountReduced = bal2025Reduced + partialReduced;
          
          const cumFactorFull = ACTUARIAL_CUM_FACTORS[year] || Math.pow(1.069, 2025 - year);
          const bal2025Full = contribution * cumFactorFull;
          const partialFull = bal2025Full * (repaymentMonth * ACTUARIAL_MONTHLY_RATE);
          const amountFull = bal2025Full + partialFull;
          
          totalReducedRate += amountReduced;
          totalFullRate += amountFull;
          
          breakdown.push({ 
            year, salary, contribution,
            cumFactorReduced, bal2025Reduced, amountReduced,
            cumFactorFull, bal2025Full, amountFull
          });
        });

        return {
          totalReducedRate,
          totalFullRate,
          breakdown,
          totalYears: edicYears.length,
          savings: totalFullRate - totalReducedRate
        };
      }, [edicYears, repaymentMonth]);

      const calculations = useMemo(() => {
        const { currentAge, expectedFinalSalary, salaryGrowthRate, lifeExpectancy, departureAge } = inputs;
        const edicServiceYears = edicYears.length;
        const currentCityServiceYears = 0; // City service accrues from now forward; EDIC buyback added separately
        const table = GROUP1_TABLE_POST_2012;
        const minRetirementAge = 60;
        const avgYears = 5;
        const VESTING_YEARS = 10;
        const MAX_BENEFIT_PERCENT = 80;
        
        // If departure age is set, service and salary freeze at that point
        const willDepart = departureAge && departureAge > currentAge && departureAge < 70;
        const yearsUntilDeparture = willDepart ? departureAge - currentAge : null;
        const frozenServiceYears = willDepart ? currentCityServiceYears + yearsUntilDeparture : null;

        const projectSalary = (yearsFromNow) => expectedFinalSalary * Math.pow(1 + salaryGrowthRate / 100, yearsFromNow);
        
        // Get all EDIC salaries (for buyback years)
        const edicSalaries = edicYears.map(y => y.salary);
        
        // Calculate highest 5-year avg salary
        // Must have at least 5 salary years in the pool; always divides by 5
        const getHighestAvgSalary = (retirementAge, includeBuyback) => {
          const yearsUntilRetirement = retirementAge - currentAge;
          const allSalaries = [];
          
          // Add EDIC salaries if buyback is included
          if (includeBuyback && edicSalaries.length > 0) {
            allSalaries.push(...edicSalaries);
          }
          
          // Add City salaries up to retirement or departure
          const maxCityYears = willDepart ? Math.min(yearsUntilRetirement, yearsUntilDeparture) : yearsUntilRetirement;
          for (let i = 0; i <= Math.max(0, maxCityYears); i++) {
            allSalaries.push(projectSalary(i));
          }
          
          // Must have at least 5 salary years to calculate the average
          if (allSalaries.length < avgYears) return 0;
          
          // Sort descending, take top 5, divide by 5
          allSalaries.sort((a, b) => b - a);
          return allSalaries.slice(0, avgYears).reduce((a, b) => a + b, 0) / avgYears;
        };
        
        // Calculate frozen salary if departing early (without buyback for comparison)
        const getFrozenHighestAvgSalary = (includeBuyback) => {
          if (!willDepart) return null;
          return getHighestAvgSalary(departureAge, includeBuyback);
        };
        
        const frozenAvgSalary = getFrozenHighestAvgSalary(false);
        const frozenAvgSalaryWithBuyback = getFrozenHighestAvgSalary(true);

        const getBenefitPercent = (age, serviceYears) => {
          const basePercent = table[age] || 0;
          return Math.min(basePercent * serviceYears, MAX_BENEFIT_PERCENT);
        };
        
        const getServiceAtRetirement = (retireAge) => {
          if (willDepart && retireAge >= departureAge) {
            // Service frozen at departure
            return frozenServiceYears;
          }
          const yearsUntilRetirement = retireAge - currentAge;
          return currentCityServiceYears + Math.max(0, yearsUntilRetirement);
        };

        // Count total salary years available at a given retirement age
        const getSalaryYearCount = (retirementAge, includeBuyback) => {
          const yearsUntilRetirement = retirementAge - currentAge;
          const maxCityYears = willDepart ? Math.min(yearsUntilRetirement, yearsUntilDeparture) : yearsUntilRetirement;
          const cityCount = Math.max(0, maxCityYears) + 1;
          return cityCount + (includeBuyback ? edicSalaries.length : 0);
        };

        const scenarios = [];
        
        for (let retireAge = 45; retireAge <= 70; retireAge++) {
          const yearsUntilRetirement = retireAge - currentAge;
          const serviceAtRetirement = getServiceAtRetirement(retireAge);
          const serviceWithBuyback = serviceAtRetirement + edicServiceYears;
          
          // Vesting check: need >= 10 years of service
          const notVestedWithout = serviceAtRetirement < VESTING_YEARS;
          const notVestedWith = serviceWithBuyback < VESTING_YEARS;

          // Salary year check: need >= 5 salary years for the average
          const tooFewYearsWithout = getSalaryYearCount(retireAge, false) < avgYears;
          const tooFewYearsWith = getSalaryYearCount(retireAge, true) < avgYears;
          
          // Calculate avg salary WITHOUT buyback (only City years)
          const avgSalaryWithout = getHighestAvgSalary(retireAge, false);
          // Calculate avg salary WITH buyback (EDIC + City years)
          const avgSalaryWith = getHighestAvgSalary(retireAge, true);

          const percentWithout = getBenefitPercent(retireAge, serviceAtRetirement);
          const percentWith = getBenefitPercent(retireAge, serviceWithBuyback);
          
          const annualPensionWithout = (notVestedWithout || tooFewYearsWithout) ? 0 : avgSalaryWithout * (percentWithout / 100);
          const annualPensionWith = (notVestedWith || tooFewYearsWith) ? 0 : avgSalaryWith * (percentWith / 100);
          const annualBenefit = annualPensionWith - annualPensionWithout;

          const yearsCollecting = lifeExpectancy - retireAge;
          const lifetimeBenefitWithout = annualPensionWithout * yearsCollecting;
          const lifetimeBenefitWith = annualPensionWith * yearsCollecting;
          const lifetimeGain = lifetimeBenefitWith - lifetimeBenefitWithout;

          const buybackCost = buybackCalculation.totalReducedRate;
          const buybackCostFull = buybackCalculation.totalFullRate;
          
          const netLifetimeGain = lifetimeGain - buybackCost;
          const roi = buybackCost > 0 ? (netLifetimeGain / buybackCost) * 100 : 0;
          const paybackYears = annualBenefit > 0 ? buybackCost / annualBenefit : Infinity;

          const hitsMaxWithout = percentWithout >= MAX_BENEFIT_PERCENT;
          const hitsMaxWith = percentWith >= MAX_BENEFIT_PERCENT;
          
          // Eligibility checks
          const tooYoung = retireAge < minRetirementAge;
          const alreadyPast = retireAge <= currentAge;
          const notEligible = tooYoung || percentWithout === 0;

          scenarios.push({
            retireAge, yearsUntilRetirement, serviceAtRetirement, serviceWithBuyback, 
            avgSalaryWithout, avgSalaryWith,
            percentWithout, percentWith, annualPensionWithout, annualPensionWith, annualBenefit,
            lifetimeBenefitWithout, lifetimeBenefitWith, lifetimeGain, buybackCost, buybackCostFull,
            netLifetimeGain, roi, paybackYears, hitsMaxWithout, hitsMaxWith, buybackWasted: hitsMaxWithout, yearsCollecting,
            tooYoung, alreadyPast, notEligible, notVestedWithout, notVestedWith, 
            tooFewYearsWithout, tooFewYearsWith, minRetirementAge
          });
        }

        const eligibleScenarios = scenarios.filter(s => !s.notEligible && !s.alreadyPast);
        
        // Global vesting check: are they vested at the latest possible retirement age (70)?
        const maxScenario = scenarios.find(s => s.retireAge === 70);
        const neverVestedWithout = maxScenario ? maxScenario.notVestedWithout : true;
        const neverVestedWith = maxScenario ? maxScenario.notVestedWith : true;

        return {
          scenarios,
          optimalWithBuyback: eligibleScenarios.filter(s => !s.buybackWasted && !s.notVestedWith).sort((a, b) => b.lifetimeBenefitWith - a.lifetimeBenefitWith)[0],
          optimalWithoutBuyback: eligibleScenarios.filter(s => !s.notVestedWithout).sort((a, b) => b.lifetimeBenefitWithout - a.lifetimeBenefitWithout)[0],
          bestBuybackROI: eligibleScenarios.filter(s => !s.buybackWasted && !s.notVestedWith && s.roi > 0).sort((a, b) => b.roi - a.roi)[0],
          minRetirementAge, avgYears, edicServiceYears, VESTING_YEARS,
          willDepart, departureAge: willDepart ? departureAge : null, frozenServiceYears, frozenAvgSalary,
          neverVestedWithout, neverVestedWith
        };
      }, [inputs, edicYears, buybackCalculation]);

      const formatCurrency = (num) => {
        if (num >= 1000000) return `$${(num / 1000000).toFixed(2)}M`;
        if (num >= 1000) return `$${(num / 1000).toFixed(0)}K`;
        return `$${num.toFixed(0)}`;
      };

      const formatCurrencyFull = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
      const formatPercent = (num) => `${num.toFixed(1)}%`;

      const generatePDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 14;
        let y = 20;

        const checkPageBreak = (needed) => {
          if (y + needed > pageHeight - 20) {
            doc.addPage();
            y = 20;
          }
        };

        const sectionHeader = (text) => {
          checkPageBreak(20);
          doc.setFontSize(14);
          doc.setTextColor(40, 80, 120);
          doc.text(text, margin, y);
          y += 2;
          doc.setDrawColor(40, 80, 120);
          doc.setLineWidth(0.5);
          doc.line(margin, y, pageWidth - margin, y);
          y += 8;
        };

        const label = (text, x, yPos) => {
          doc.setFontSize(8);
          doc.setTextColor(120, 140, 160);
          doc.text(text, x, yPos);
        };

        const value = (text, x, yPos, color) => {
          doc.setFontSize(11);
          doc.setTextColor(...(color || [40, 60, 80]));
          doc.text(text, x, yPos);
        };

        // ===== TITLE =====
        doc.setFontSize(22);
        doc.setTextColor(40, 80, 120);
        doc.text('Boston Retirement System', pageWidth / 2, y, { align: 'center' });
        y += 9;
        doc.setFontSize(15);
        doc.setTextColor(60, 100, 140);
        doc.text('Pension Optimization Report', pageWidth / 2, y, { align: 'center' });
        y += 6;
        doc.setFontSize(9);
        doc.setTextColor(130, 130, 130);
        doc.text(`Generated: ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, pageWidth / 2, y, { align: 'center' });
        y += 5;
        doc.setFontSize(8);
        doc.text('Group 1 • Post-April 2, 2012 (5-year avg)', pageWidth / 2, y, { align: 'center' });
        y += 12;

        // ===== PERSONAL INFORMATION =====
        sectionHeader('Personal Information');
        const infoColWidth = (pageWidth - 2 * margin) / 3;
        
        const infoItems = [
          ['Current Age', `${inputs.currentAge}`],
          ['EDIC Buyback Years', `${edicYears.length} years`],
          ['Current Annual Salary', formatCurrencyFull(inputs.expectedFinalSalary)],
          ['Expected Salary Growth', `${inputs.salaryGrowthRate}% per year`],
          ['Life Expectancy', `${inputs.lifeExpectancy}`],
        ];
        if (inputs.departureAge) {
          infoItems.push(['Planned Departure Age', `${inputs.departureAge}`]);
        }

        infoItems.forEach((item, i) => {
          const col = i % 3;
          const x = margin + col * infoColWidth;
          if (i > 0 && col === 0) y += 14;
          label(item[0], x, y);
          value(item[1], x, y + 5);
        });
        y += 20;

        // ===== EARLY DEPARTURE NOTICE =====
        if (calculations.willDepart) {
          checkPageBreak(20);
          doc.setFillColor(255, 245, 220);
          doc.roundedRect(margin, y - 4, pageWidth - 2 * margin, 16, 3, 3, 'F');
          doc.setFontSize(10);
          doc.setTextColor(160, 100, 20);
          doc.text(`Early Departure at Age ${calculations.departureAge}`, margin + 6, y + 3);
          doc.setFontSize(9);
          doc.setTextColor(140, 110, 60);
          doc.text(`Service freezes at ${calculations.frozenServiceYears?.toFixed(1)} years  •  Salary freezes at ${formatCurrency(calculations.frozenAvgSalary)} avg  •  Pension starts at age ${calculations.minRetirementAge}`, margin + 6, y + 9);
          y += 18;
        }

        // ===== EDIC SERVICE HISTORY + BUYBACK BREAKDOWN =====
        if (edicYears.length > 0) {
          sectionHeader('EDIC Service History & Buyback Cost Breakdown');

          // Full year-by-year breakdown table (mirrors the website's expandable detail)
          const breakdownData = buybackCalculation.breakdown.map(row => [
            row.year.toString(),
            formatCurrencyFull(row.salary),
            formatCurrencyFull(row.contribution),
            row.cumFactorReduced.toFixed(4),
            formatCurrencyFull(row.bal2025Reduced),
            formatCurrencyFull(row.amountReduced),
            row.cumFactorFull.toFixed(4),
            formatCurrencyFull(row.bal2025Full),
            formatCurrencyFull(row.amountFull)
          ]);

          doc.autoTable({
            startY: y,
            head: [['Year', 'Salary', 'Contribution', 'Factor (3.45%)', 'Bal 12/31/25', 'Total @ 3.45%', 'Factor (6.9%)', 'Bal 12/31/25', 'Total @ 6.9%']],
            body: breakdownData,
            theme: 'striped',
            headStyles: { fillColor: [40, 80, 120], fontSize: 7.5, cellPadding: 3 },
            bodyStyles: { fontSize: 8, cellPadding: 2.5 },
            columnStyles: {
              0: { halign: 'center' },
              1: { halign: 'right' },
              2: { halign: 'right' },
              3: { halign: 'center', textColor: [100, 140, 180] },
              4: { halign: 'right' },
              5: { halign: 'right', textColor: [40, 140, 80] },
              6: { halign: 'center', textColor: [100, 140, 180] },
              7: { halign: 'right' },
              8: { halign: 'right', textColor: [200, 130, 60] }
            },
            margin: { left: margin, right: margin },
            alternateRowStyles: { fillColor: [240, 246, 252] }
          });

          y = doc.lastAutoTable.finalY + 8;

          // Buyback Cost Summary Box
          checkPageBreak(30);
          doc.setFillColor(235, 245, 255);
          doc.roundedRect(margin, y - 2, pageWidth - 2 * margin, 28, 3, 3, 'F');
          doc.setDrawColor(40, 80, 120);
          doc.setLineWidth(0.3);
          doc.roundedRect(margin, y - 2, pageWidth - 2 * margin, 28, 3, 3, 'S');

          const summaryCol = (pageWidth - 2 * margin) / 4;
          
          label('TOTAL YEARS', margin + 6, y + 3);
          doc.setFontSize(16);
          doc.setTextColor(40, 60, 80);
          doc.text(`${buybackCalculation.totalYears}`, margin + 6, y + 12);

          label('COST AT 3.45% (BUYBACK INTEREST)', margin + 6 + summaryCol, y + 3);
          doc.setFontSize(16);
          doc.setTextColor(40, 160, 80);
          doc.text(formatCurrencyFull(buybackCalculation.totalReducedRate), margin + 6 + summaryCol, y + 12);
          doc.setFontSize(7);
          doc.setTextColor(100, 140, 100);
          doc.text('Apply by Nov 2026 for this rate', margin + 6 + summaryCol, y + 17);

          label('COST AT 6.9% (ACTUARIAL INTEREST)', margin + 6 + summaryCol * 2, y + 3);
          doc.setFontSize(16);
          doc.setTextColor(200, 130, 60);
          doc.text(formatCurrencyFull(buybackCalculation.totalFullRate), margin + 6 + summaryCol * 2, y + 12);

          label('YOU SAVE WITH BUYBACK RATE', margin + 6 + summaryCol * 3, y + 3);
          doc.setFontSize(16);
          doc.setTextColor(40, 160, 80);
          doc.text(formatCurrencyFull(buybackCalculation.savings), margin + 6 + summaryCol * 3, y + 12);

          doc.setFontSize(7);
          doc.setTextColor(130, 130, 130);
          doc.text(`Repayment: ${MONTH_NAMES[repaymentMonth - 1]} ${repaymentYear}  •  Interest factors from official BRS cumulative tables to 12/31/2025 + partial ${repaymentYear}`, margin + 6, y + 23);
          
          y += 34;
        }

        // ===== KEY INSIGHTS =====
        doc.addPage();
        y = 20;
        sectionHeader('Key Insights');

        const cardWidth = (pageWidth - 2 * margin - 16) / 3;
        const cardHeight = 44;
        const cardY = y;

        // Card 1: Best with Buyback
        if (calculations.optimalWithBuyback) {
          const s = calculations.optimalWithBuyback;
          const cx = margin;
          doc.setFillColor(230, 245, 255);
          doc.roundedRect(cx, cardY, cardWidth, cardHeight, 3, 3, 'F');
          doc.setDrawColor(40, 120, 180);
          doc.setLineWidth(0.5);
          doc.roundedRect(cx, cardY, cardWidth, cardHeight, 3, 3, 'S');
          
          doc.setFontSize(8);
          doc.setTextColor(40, 120, 180);
          doc.text('BEST WITH BUYBACK — RECOMMENDED', cx + 5, cardY + 7);
          doc.setFontSize(22);
          doc.setTextColor(30, 70, 110);
          doc.text(`Age ${s.retireAge}`, cx + 5, cardY + 19);
          doc.setFontSize(8);
          doc.setTextColor(80, 120, 160);
          doc.text(`${s.serviceWithBuyback.toFixed(1)} yrs service  •  ${formatPercent(s.percentWith)} of salary`, cx + 5, cardY + 25);
          
          doc.setFontSize(7);
          doc.setTextColor(100, 130, 160);
          doc.text('Annual Pension', cx + 5, cardY + 32);
          doc.text('Lifetime Total', cx + cardWidth / 2, cardY + 32);
          doc.setFontSize(11);
          doc.setTextColor(40, 160, 60);
          doc.text(formatCurrency(s.annualPensionWith), cx + 5, cardY + 39);
          doc.text(formatCurrency(s.lifetimeBenefitWith), cx + cardWidth / 2, cardY + 39);
        }

        // Card 2: Buyback Investment
        if (calculations.bestBuybackROI && edicYears.length > 0) {
          const s = calculations.bestBuybackROI;
          const cx = margin + cardWidth + 8;
          doc.setFillColor(255, 248, 235);
          doc.roundedRect(cx, cardY, cardWidth, cardHeight, 3, 3, 'F');
          doc.setDrawColor(180, 140, 60);
          doc.setLineWidth(0.3);
          doc.roundedRect(cx, cardY, cardWidth, cardHeight, 3, 3, 'S');
          
          doc.setFontSize(8);
          doc.setTextColor(160, 120, 40);
          doc.text('BUYBACK INVESTMENT', cx + 5, cardY + 7);
          doc.setFontSize(22);
          doc.setTextColor(180, 130, 40);
          doc.text(formatCurrency(s.buybackCost), cx + 5, cardY + 19);
          doc.setFontSize(8);
          doc.setTextColor(140, 110, 60);
          doc.text('Cost at 3.45% rate', cx + 5, cardY + 25);
          
          doc.setFontSize(7);
          doc.setTextColor(100, 130, 160);
          doc.text('Lifetime ROI', cx + 5, cardY + 32);
          doc.text('Payback Period', cx + cardWidth / 2, cardY + 32);
          doc.setFontSize(11);
          doc.setTextColor(s.roi > 0 ? [40, 160, 60] : [200, 60, 60]);
          doc.text(formatPercent(s.roi), cx + 5, cardY + 39);
          doc.setTextColor(80, 100, 130);
          doc.text(s.paybackYears < 100 ? `${s.paybackYears.toFixed(1)} years` : 'N/A', cx + cardWidth / 2, cardY + 39);
        }

        // Card 3: Without Buyback
        if (calculations.optimalWithoutBuyback) {
          const s = calculations.optimalWithoutBuyback;
          const cx = margin + (cardWidth + 8) * 2;
          doc.setFillColor(240, 244, 248);
          doc.roundedRect(cx, cardY, cardWidth, cardHeight, 3, 3, 'F');
          doc.setDrawColor(140, 160, 180);
          doc.setLineWidth(0.3);
          doc.roundedRect(cx, cardY, cardWidth, cardHeight, 3, 3, 'S');
          
          doc.setFontSize(8);
          doc.setTextColor(100, 130, 160);
          doc.text('WITHOUT BUYBACK', cx + 5, cardY + 7);
          doc.setFontSize(22);
          doc.setTextColor(80, 110, 140);
          doc.text(`Age ${s.retireAge}`, cx + 5, cardY + 19);
          doc.setFontSize(8);
          doc.setTextColor(100, 130, 160);
          doc.text(`${s.serviceAtRetirement.toFixed(1)} yrs service  •  ${formatPercent(s.percentWithout)} of salary`, cx + 5, cardY + 25);
          
          doc.setFontSize(7);
          doc.setTextColor(100, 130, 160);
          doc.text('Annual Pension', cx + 5, cardY + 32);
          doc.text('Lifetime Total', cx + cardWidth / 2, cardY + 32);
          doc.setFontSize(11);
          doc.setTextColor(80, 140, 180);
          doc.text(formatCurrency(s.annualPensionWithout), cx + 5, cardY + 39);
          doc.text(formatCurrency(s.lifetimeBenefitWithout), cx + cardWidth / 2, cardY + 39);
        }

        y = cardY + cardHeight + 16;

        // ===== ALL RETIREMENT SCENARIOS (full table matching website) =====
        sectionHeader('All Retirement Scenarios');

        const eligibleScenarios = calculations.scenarios.filter(s => !s.notEligible && !s.alreadyPast);
        const scenarioData = eligibleScenarios.map(s => {
          const isOptimal = calculations.optimalWithBuyback?.retireAge === s.retireAge;
          let status = '';
          if (s.buybackWasted) status = 'BB WASTED';
          else if (s.hitsMaxWith) status = 'MAX 80%';
          else if (isOptimal) status = '★ BEST';

          return [
            s.retireAge.toString() + (isOptimal ? ' ★' : ''),
            s.serviceAtRetirement.toFixed(1),
            s.serviceWithBuyback.toFixed(1),
            formatCurrency(s.avgSalaryWithout),
            formatCurrency(s.avgSalaryWith),
            formatPercent(s.percentWithout) + (s.hitsMaxWithout ? ' ★' : ''),
            formatPercent(s.percentWith) + (s.hitsMaxWith ? ' ★' : ''),
            formatCurrency(s.annualPensionWithout),
            formatCurrency(s.annualPensionWith),
            status
          ];
        });

        doc.autoTable({
          startY: y,
          head: [['Retire Age', 'Service', 'w/ Buyback', 'Avg Salary', 'Avg w/ BB', '% (No BB)', '% (w/ BB)', 'Annual (No BB)', 'Annual (w/ BB)', 'Status']],
          body: scenarioData,
          theme: 'striped',
          headStyles: { fillColor: [40, 80, 120], fontSize: 7.5, cellPadding: 3 },
          bodyStyles: { fontSize: 8, cellPadding: 2.5 },
          columnStyles: {
            0: { fontStyle: 'bold' },
            4: { textColor: [40, 140, 180] },
            6: { textColor: [40, 140, 180] },
            8: { textColor: [40, 160, 80] },
            9: { halign: 'center', fontSize: 7 }
          },
          margin: { left: margin, right: margin },
          alternateRowStyles: { fillColor: [240, 246, 252] },
          didParseCell: (data) => {
            if (data.section === 'body' && data.column.index === 9) {
              const val = data.cell.raw;
              if (val === 'BB WASTED') data.cell.styles.textColor = [200, 100, 40];
              else if (val === 'MAX 80%') data.cell.styles.textColor = [40, 100, 200];
              else if (val === '★ BEST') data.cell.styles.textColor = [40, 160, 60];
            }
            // Highlight the optimal row
            if (data.section === 'body' && calculations.optimalWithBuyback) {
              const rowAge = parseInt(scenarioData[data.row.index]?.[0]);
              if (rowAge === calculations.optimalWithBuyback.retireAge) {
                data.cell.styles.fillColor = [220, 245, 230];
              }
            }
          }
        });

        y = doc.lastAutoTable.finalY + 4;
        doc.setFontSize(7);
        doc.setTextColor(130, 130, 130);
        doc.text('★ = Hits 80% max  •  BB = Buyback  •  Highlighted row = recommended scenario', margin, y);
        y += 10;

        // ===== DETAILED ANALYSIS FOR EACH ELIGIBLE SCENARIO =====
        doc.addPage();
        y = 20;
        sectionHeader('Detailed Scenario Analysis');

        const detailData = eligibleScenarios.map(s => [
          s.retireAge.toString(),
          `${s.yearsUntilRetirement}`,
          `${s.yearsCollecting}`,
          formatCurrency(s.avgSalaryWithout),
          formatCurrency(s.avgSalaryWith),
          formatCurrencyFull(s.buybackCost),
          formatCurrencyFull(s.buybackCostFull),
          s.annualBenefit > 0 ? `+${formatCurrency(s.annualBenefit)}/yr` : '$0/yr',
          formatCurrency(s.lifetimeGain),
          formatCurrency(s.netLifetimeGain),
          s.buybackWasted ? 'WASTED' : (s.roi > 0 ? formatPercent(s.roi) : '—')
        ]);

        doc.autoTable({
          startY: y,
          head: [[
            'Age', 'Yrs to Retire', 'Yrs Collecting',
            `Best ${calculations.avgYears}yr Avg`, `Best ${calculations.avgYears}yr w/BB`,
            'BB Cost (3.45%)', 'BB Cost (6.9%)',
            'Annual from BB', 'Lifetime Gain', 'Net Gain', 'ROI'
          ]],
          body: detailData,
          theme: 'striped',
          headStyles: { fillColor: [40, 80, 120], fontSize: 6.5, cellPadding: 2.5 },
          bodyStyles: { fontSize: 7, cellPadding: 2 },
          columnStyles: {
            0: { fontStyle: 'bold', halign: 'center' },
            1: { halign: 'center' },
            2: { halign: 'center' },
            5: { textColor: [40, 160, 80] },
            6: { textColor: [200, 130, 60] },
            7: { textColor: [40, 140, 80] },
            10: { halign: 'center' }
          },
          margin: { left: margin, right: margin },
          alternateRowStyles: { fillColor: [240, 246, 252] },
          didParseCell: (data) => {
            if (data.section === 'body') {
              // Color net gain red if negative
              if (data.column.index === 9) {
                const raw = data.cell.raw;
                if (raw.includes('-') || raw === '$0') data.cell.styles.textColor = [200, 60, 60];
                else data.cell.styles.textColor = [40, 160, 80];
              }
              // Color ROI
              if (data.column.index === 10) {
                const raw = data.cell.raw;
                if (raw === 'WASTED') data.cell.styles.textColor = [200, 100, 40];
                else if (raw === '—') data.cell.styles.textColor = [150, 150, 150];
                else data.cell.styles.textColor = [40, 160, 80];
              }
              // Highlight optimal row
              if (calculations.optimalWithBuyback) {
                const rowAge = parseInt(detailData[data.row.index]?.[0]);
                if (rowAge === calculations.optimalWithBuyback.retireAge) {
                  data.cell.styles.fillColor = [220, 245, 230];
                }
              }
            }
          }
        });

        y = doc.lastAutoTable.finalY + 6;
        checkPageBreak(16);

        // Buyback warning note
        const wastedScenarios = eligibleScenarios.filter(s => s.buybackWasted);
        if (wastedScenarios.length > 0) {
          doc.setFillColor(255, 245, 230);
          doc.roundedRect(margin, y - 2, pageWidth - 2 * margin, 12, 2, 2, 'F');
          doc.setFontSize(8);
          doc.setTextColor(180, 100, 30);
          doc.text(
            `Buyback Warning: At age(s) ${wastedScenarios.map(s => s.retireAge).join(', ')}, you would already hit the 80% max without buyback. Buying back EDIC service would not increase your pension at those ages.`,
            margin + 4, y + 4
          );
          y += 16;
        }

        // ===== FOOTER ON ALL PAGES =====
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(7);
          doc.setTextColor(170, 170, 170);
          doc.text(
            'This is an experiment subject to errors. Do not make any decisions based on its output. Consult Human Resources for official guidance.',
            pageWidth / 2,
            pageHeight - 8,
            { align: 'center' }
          );
          doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
        }

        doc.save('pension-optimization-report.pdf');
      };

      const generateDepartureChartPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 14;

        const { currentAge, expectedFinalSalary, salaryGrowthRate, lifeExpectancy } = inputs;
        const table = GROUP1_TABLE_POST_2012;
        const avgYears = 5;
        const VESTING_YEARS = 10;
        const MAX_BENEFIT_PERCENT = 80;
        const edicServiceYears = edicYears.length;
        const currentCityServiceYears = 0; // City service accrues from now forward; EDIC buyback added separately
        const edicSalaries = edicYears.map(y => y.salary);
        const projectSalary = (yearsFromNow) => expectedFinalSalary * Math.pow(1 + salaryGrowthRate / 100, yearsFromNow);

        // For each departure age, calculate annual pension at the collection age
        // Collection age = max(60, departureAge) since minimum retirement is 60
        const dataPoints = [];
        const minDep = 45;
        const maxDep = 65;

        for (let depAge = minDep; depAge <= maxDep; depAge++) {
          const yearsUntilDeparture = depAge - currentAge;
          const collectionAge = Math.max(60, depAge);

          if (yearsUntilDeparture < 0) {
            // Departure age is in the past — no city service, but EDIC buyback alone can qualify
            const notVestedNoBB = true;
            const notVestedBB = edicServiceYears < VESTING_YEARS;
            
            let annualWithBB = 0;
            if (!notVestedBB && edicSalaries.length >= avgYears) {
              const sorted = [...edicSalaries].sort((a, b) => b - a);
              const avg = sorted.slice(0, avgYears).reduce((a, b) => a + b, 0) / avgYears;
              const basePercent = table[collectionAge] || 0;
              const percent = Math.min(basePercent * edicServiceYears, MAX_BENEFIT_PERCENT);
              annualWithBB = avg * (percent / 100);
            }
            
            dataPoints.push({ depAge, withoutBB: 0, withBB: annualWithBB, collectionAge, notVestedWithout: true, notVestedWith: notVestedBB });
            continue;
          }

          const frozenService = currentCityServiceYears + yearsUntilDeparture;
          const serviceWithBB = frozenService + edicServiceYears;

          // Vesting check
          const notVestedWithout = frozenService < VESTING_YEARS;
          const notVestedWith = serviceWithBB < VESTING_YEARS;

          // Build salary history up to departure
          const citySalaries = [];
          for (let i = 0; i <= yearsUntilDeparture; i++) {
            citySalaries.push(projectSalary(i));
          }

          // Highest 5-year avg WITHOUT buyback (need >= 5 salary years)
          const salariesNoBB = [...citySalaries].sort((a, b) => b - a);
          const avgNoBB = (salariesNoBB.length >= avgYears && !notVestedWithout) 
            ? salariesNoBB.slice(0, avgYears).reduce((a, b) => a + b, 0) / avgYears : 0;

          // Highest 5-year avg WITH buyback (need >= 5 salary years from combined pool)
          const salariesWithBB = [...citySalaries, ...edicSalaries].sort((a, b) => b - a);
          const avgWithBB = (salariesWithBB.length >= avgYears && !notVestedWith)
            ? salariesWithBB.slice(0, avgYears).reduce((a, b) => a + b, 0) / avgYears : 0;

          const basePercent = table[collectionAge] || 0;
          const percentNoBB = Math.min(basePercent * frozenService, MAX_BENEFIT_PERCENT);
          const percentWithBB = Math.min(basePercent * serviceWithBB, MAX_BENEFIT_PERCENT);

          const annualNoBB = notVestedWithout ? 0 : avgNoBB * (percentNoBB / 100);
          const annualWithBB = notVestedWith ? 0 : avgWithBB * (percentWithBB / 100);

          dataPoints.push({ depAge, withoutBB: annualNoBB, withBB: annualWithBB, collectionAge, notVestedWithout, notVestedWith });
        }

        // ===== TITLE =====
        let y = 20;
        doc.setFontSize(22);
        doc.setTextColor(40, 80, 120);
        doc.text('Boston Retirement System', pageWidth / 2, y, { align: 'center' });
        y += 9;
        doc.setFontSize(15);
        doc.setTextColor(60, 100, 140);
        doc.text('Projected Annual Pension by Departure Age', pageWidth / 2, y, { align: 'center' });
        y += 6;
        doc.setFontSize(9);
        doc.setTextColor(130, 130, 130);
        doc.text(`Generated: ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, pageWidth / 2, y, { align: 'center' });
        y += 5;
        doc.setFontSize(8);
        doc.setTextColor(130, 130, 130);
        doc.text(`Current Age: ${currentAge}  •  Salary: ${formatCurrencyFull(expectedFinalSalary)}  •  Growth: ${salaryGrowthRate}%/yr  •  EDIC Years: ${edicServiceYears}  •  Group 1 Post-April 2, 2012`, pageWidth / 2, y, { align: 'center' });
        y += 12;

        // ===== CHART AREA =====
        const chartLeft = margin + 50;
        const chartRight = pageWidth - margin - 20;
        const chartTop = y + 5;
        const chartBottom = pageHeight - 70;
        const chartWidth = chartRight - chartLeft;
        const chartHeight = chartBottom - chartTop;

        // Y-axis range
        const allValues = dataPoints.map(d => Math.max(d.withoutBB, d.withBB));
        const yMax = Math.ceil(Math.max(...allValues) / 10000) * 10000;
        const yMin = 0;
        const yRange = yMax - yMin;

        // Draw axes
        doc.setDrawColor(80, 110, 140);
        doc.setLineWidth(0.5);
        doc.line(chartLeft, chartTop, chartLeft, chartBottom);        // Y-axis
        doc.line(chartLeft, chartBottom, chartRight, chartBottom);    // X-axis

        // Y-axis grid lines and labels
        const yTicks = 6;
        const yStep = yRange / yTicks;
        doc.setFontSize(8);
        for (let i = 0; i <= yTicks; i++) {
          const val = yMin + yStep * i;
          const yPos = chartBottom - (i / yTicks) * chartHeight;
          
          // Grid line
          doc.setDrawColor(200, 215, 230);
          doc.setLineWidth(0.15);
          doc.line(chartLeft, yPos, chartRight, yPos);
          
          // Label
          doc.setTextColor(100, 130, 160);
          const label = val >= 1000 ? `$${(val / 1000).toFixed(0)}K` : `$${val.toFixed(0)}`;
          doc.text(label, chartLeft - 4, yPos + 2, { align: 'right' });
        }

        // Y-axis title
        doc.setFontSize(10);
        doc.setTextColor(60, 90, 120);
        doc.text('Annual Pension Income', margin + 4, chartTop + chartHeight / 2, { angle: 90 });

        // X-axis labels
        const numPoints = maxDep - minDep;
        doc.setFontSize(8);
        for (let depAge = minDep; depAge <= maxDep; depAge++) {
          const xPos = chartLeft + ((depAge - minDep) / numPoints) * chartWidth;
          
          // Tick mark
          doc.setDrawColor(80, 110, 140);
          doc.setLineWidth(0.3);
          doc.line(xPos, chartBottom, xPos, chartBottom + 3);
          
          // Label (every age, or every other if crowded)
          doc.setTextColor(100, 130, 160);
          doc.text(`${depAge}`, xPos, chartBottom + 9, { align: 'center' });
        }

        // X-axis title
        doc.setFontSize(10);
        doc.setTextColor(60, 90, 120);
        doc.text('Departure Age', chartLeft + chartWidth / 2, chartBottom + 18, { align: 'center' });

        // Helper: convert data to chart coords
        const toX = (depAge) => chartLeft + ((depAge - minDep) / numPoints) * chartWidth;
        const toY = (val) => chartBottom - ((val - yMin) / yRange) * chartHeight;

        // Draw "Without Buyback" line
        doc.setDrawColor(100, 160, 210);
        doc.setLineWidth(1.2);
        for (let i = 1; i < dataPoints.length; i++) {
          const p0 = dataPoints[i - 1];
          const p1 = dataPoints[i];
          if (p0.withoutBB > 0 || p1.withoutBB > 0) {
            doc.line(toX(p0.depAge), toY(p0.withoutBB), toX(p1.depAge), toY(p1.withoutBB));
          }
        }

        // Draw dots for Without Buyback
        dataPoints.forEach(d => {
          if (d.withoutBB > 0) {
            doc.setFillColor(100, 160, 210);
            doc.circle(toX(d.depAge), toY(d.withoutBB), 1.5, 'F');
          }
        });

        // Draw "With Buyback" line
        if (edicServiceYears > 0) {
          doc.setDrawColor(60, 190, 100);
          doc.setLineWidth(1.2);
          for (let i = 1; i < dataPoints.length; i++) {
            const p0 = dataPoints[i - 1];
            const p1 = dataPoints[i];
            if (p0.withBB > 0 || p1.withBB > 0) {
              doc.line(toX(p0.depAge), toY(p0.withBB), toX(p1.depAge), toY(p1.withBB));
            }
          }

          // Draw dots for With Buyback
          dataPoints.forEach(d => {
            if (d.withBB > 0) {
              doc.setFillColor(60, 190, 100);
              doc.circle(toX(d.depAge), toY(d.withBB), 1.5, 'F');
            }
          });
        }

        // ===== LEGEND (below chart) =====
        const legendX = chartLeft + chartWidth / 2 - (edicServiceYears > 0 ? 75 : 40);
        const legendY = chartBottom + 24;

        // Without Buyback legend
        doc.setDrawColor(100, 160, 210);
        doc.setLineWidth(1.5);
        doc.line(legendX, legendY, legendX + 12, legendY);
        doc.setFillColor(100, 160, 210);
        doc.circle(legendX + 6, legendY, 1.2, 'F');
        doc.setFontSize(8);
        doc.setTextColor(60, 90, 120);
        doc.text('Without Buyback', legendX + 16, legendY + 2.5);

        // With Buyback legend
        if (edicServiceYears > 0) {
          const bbLegendX = legendX + 90;
          doc.setDrawColor(60, 190, 100);
          doc.setLineWidth(1.5);
          doc.line(bbLegendX, legendY, bbLegendX + 12, legendY);
          doc.setFillColor(60, 190, 100);
          doc.circle(bbLegendX + 6, legendY, 1.2, 'F');
          doc.setTextColor(60, 90, 120);
          doc.text('With Buyback', bbLegendX + 16, legendY + 2.5);
        }

        // ===== DATA TABLE ON PAGE 2 =====
        doc.addPage();
        let y2 = 20;
        doc.setFontSize(14);
        doc.setTextColor(40, 80, 120);
        doc.text('Projected Annual Pension by Departure Age — Detail', margin, y2);
        y2 += 2;
        doc.setDrawColor(40, 80, 120);
        doc.setLineWidth(0.5);
        doc.line(margin, y2, pageWidth - margin, y2);
        y2 += 8;

        const tableData = dataPoints
          .filter(d => d.depAge >= currentAge)
          .map(d => {
            const yearsFromNow = d.depAge - currentAge;
            const frozenService = currentCityServiceYears + yearsFromNow;
            const serviceWithBB = frozenService + edicServiceYears;
            const diff = d.withBB - d.withoutBB;
            let status = '';
            if (d.notVestedWith) status = 'NOT VESTED';
            else if (d.notVestedWithout && !d.notVestedWith && edicServiceYears > 0) status = 'BB REQ\'D';
            return [
              d.depAge.toString(),
              `${yearsFromNow}`,
              frozenService.toFixed(1),
              edicServiceYears > 0 ? serviceWithBB.toFixed(1) : '—',
              d.collectionAge.toString(),
              d.notVestedWithout ? 'Not vested' : formatCurrencyFull(Math.round(d.withoutBB)),
              d.notVestedWith ? 'Not vested' : (edicServiceYears > 0 ? formatCurrencyFull(Math.round(d.withBB)) : '—'),
              d.notVestedWith ? '—' : (edicServiceYears > 0 ? (diff > 0 ? `+${formatCurrencyFull(Math.round(diff))}` : formatCurrencyFull(Math.round(diff))) : '—'),
              status
            ];
          });

        doc.autoTable({
          startY: y2,
          head: [['Departure Age', 'Years from Now', 'City Service', 'w/ Buyback', 'Collection Age', 'Annual (No BB)', 'Annual (w/ BB)', 'BB Benefit', 'Status']],
          body: tableData,
          theme: 'striped',
          headStyles: { fillColor: [40, 80, 120], fontSize: 8, cellPadding: 3 },
          bodyStyles: { fontSize: 8.5, cellPadding: 2.5 },
          columnStyles: {
            0: { fontStyle: 'bold', halign: 'center' },
            1: { halign: 'center' },
            2: { halign: 'center' },
            3: { halign: 'center', textColor: [40, 160, 80] },
            4: { halign: 'center' },
            5: { halign: 'right', textColor: [60, 120, 180] },
            6: { halign: 'right', textColor: [40, 160, 80] },
            7: { halign: 'right' },
            8: { halign: 'center', fontSize: 7 }
          },
          margin: { left: margin, right: margin },
          alternateRowStyles: { fillColor: [240, 246, 252] },
          didParseCell: (data) => {
            if (data.section === 'body' && data.column.index === 7) {
              const raw = data.cell.raw;
              if (raw.startsWith('+')) data.cell.styles.textColor = [40, 160, 80];
              else if (raw === '—') data.cell.styles.textColor = [150, 150, 150];
              else data.cell.styles.textColor = [200, 60, 60];
            }
            if (data.section === 'body' && data.column.index === 5) {
              if (data.cell.raw === 'Not vested') data.cell.styles.textColor = [200, 60, 60];
            }
            if (data.section === 'body' && data.column.index === 6) {
              if (data.cell.raw === 'Not vested') data.cell.styles.textColor = [200, 60, 60];
            }
            if (data.section === 'body' && data.column.index === 8) {
              const raw = data.cell.raw;
              if (raw === 'NOT VESTED') data.cell.styles.textColor = [200, 60, 60];
              else if (raw === "BB REQ'D") data.cell.styles.textColor = [200, 150, 40];
            }
          }
        });

        y2 = doc.lastAutoTable.finalY + 6;
        doc.setFontSize(7.5);
        doc.setTextColor(130, 130, 130);
        doc.text('Collection age = max(60, departure age). Pension begins at earliest eligible retirement age. Vesting requires 10+ years of creditable service.', margin, y2);
        y2 += 4;
        doc.text('Service years freeze at departure. Salary growth stops at departure. Highest 5-year average requires at least 5 salary years in pool.', margin, y2);

        // ===== FOOTER ON ALL PAGES =====
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(7);
          doc.setTextColor(170, 170, 170);
          doc.text(
            'This is an experiment subject to errors. Do not make any decisions based on its output. Consult Human Resources for official guidance.',
            pageWidth / 2,
            pageHeight - 8,
            { align: 'center' }
          );
          doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
        }

        doc.save('pension-departure-age-chart.pdf');
      };

      const styles = {
        container: { minHeight: '100vh', background: 'linear-gradient(135deg, #0a1628 0%, #1a2d4a 50%, #0f1d32 100%)', fontFamily: "'IBM Plex Sans', -apple-system, sans-serif", color: '#e8f0f8', padding: '24px' },
        card: { background: 'linear-gradient(145deg, rgba(30,50,80,0.8), rgba(20,35,60,0.9))', border: '1px solid rgba(100,150,200,0.2)', borderRadius: '16px' },
        highlightCard: { background: 'linear-gradient(145deg, rgba(40,80,120,0.9), rgba(30,60,100,0.95))', border: '1px solid rgba(100,180,240,0.4)', borderRadius: '16px' },
        statValue: { fontFamily: "'IBM Plex Mono', monospace", fontWeight: 500 },
        badge: { display: 'inline-block', padding: '3px 8px', borderRadius: '12px', fontSize: '11px', fontWeight: 600, textTransform: 'uppercase' },
        badgeOptimal: { background: 'linear-gradient(135deg, #2e7d32, #4caf50)', color: 'white' },
        badgeWarning: { background: 'linear-gradient(135deg, #e65100, #ff9800)', color: 'white' },
        badgeMax: { background: 'linear-gradient(135deg, #1565c0, #42a5f5)', color: 'white' },
        toggleBtn: { background: 'rgba(60,100,150,0.3)', border: '1px solid rgba(100,150,200,0.3)', color: '#a0c4e8', padding: '8px 16px', borderRadius: '8px', cursor: 'pointer', fontFamily: 'inherit', fontSize: '14px' },
        toggleBtnActive: { background: 'linear-gradient(135deg, #2a6090, #3a80b0)', borderColor: '#60b0e0', color: 'white' },
        smallBtn: { background: 'rgba(60,100,150,0.3)', border: '1px solid rgba(100,150,200,0.3)', color: '#a0c4e8', padding: '6px 12px', borderRadius: '6px', cursor: 'pointer', fontFamily: 'inherit', fontSize: '12px' },
        applyBtn: { background: 'linear-gradient(135deg, #2e7d32, #4caf50)', border: 'none', color: 'white', padding: '10px 20px', borderRadius: '8px', cursor: 'pointer', fontFamily: 'inherit', fontSize: '14px', fontWeight: '500' }
      };

      return (
        <div style={styles.container}>
          <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
            {/* Header */}
            <header style={{ marginBottom: '32px', textAlign: 'center' }}>
              <div style={{ display: 'inline-block', padding: '6px 16px', background: 'rgba(60,120,180,0.2)', borderRadius: '20px', marginBottom: '12px', fontSize: '12px', letterSpacing: '1.5px', textTransform: 'uppercase', color: '#80b8e8' }}>
                Boston Retirement System • Group 1
              </div>
              <h1 style={{ fontSize: '36px', fontWeight: '700', margin: '0 0 8px 0', background: 'linear-gradient(135deg, #e8f4ff, #a0d0f0)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                Pension Optimization Tool
              </h1>
              <div style={{ 
                border: '3px solid #ffd700',
                borderRadius: '12px',
                padding: '16px 20px',
                background: 'rgba(255,215,0,0.08)',
                boxShadow: '0 0 20px rgba(255,215,0,0.2)',
                marginTop: '12px'
              }}>
                <p style={{ color: '#8ab4d8', margin: 0, fontSize: '15px' }}>
                  This calculator is an experiment subject to errors. Do not make any decisions based on its output. 
                  Send Ted any ideas for improving this tool! <a 
                    href="#feedback-form" 
                    style={{ 
                      color: '#ffd700', 
                      textDecoration: 'underline',
                      fontWeight: 600
                    }}
                  >
                    Click here
                  </a>.
                </p>
              </div>
            </header>

            {/* EDIC Service History */}
            <div style={{ ...styles.card, padding: '28px', marginBottom: '24px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
                <h2 style={{ fontSize: '18px', fontWeight: '600', margin: 0, color: '#c0daf0', display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <span style={{ width: '28px', height: '28px', background: 'linear-gradient(135deg, #3080b0, #60b0e0)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px' }}>1</span>
                  EDIC Service History
                </h2>
                
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button style={{ ...styles.smallBtn, ...(entryMode === 'manual' ? styles.toggleBtnActive : {}) }} onClick={() => setEntryMode('manual')}>Enter Manually</button>
                  <button style={{ ...styles.smallBtn, ...(entryMode === 'quickfill' ? styles.toggleBtnActive : {}) }} onClick={() => setEntryMode('quickfill')}>Quick Fill</button>
                  <button style={{ ...styles.smallBtn, ...(entryMode === 'paste' ? styles.toggleBtnActive : {}) }} onClick={() => setEntryMode('paste')}>Paste from Spreadsheet</button>
                  {edicYears.length > 0 && <button style={styles.smallBtn} onClick={clearAll}>Clear All</button>}
                </div>
              </div>

              {entryMode === 'quickfill' ? (
                <div style={{ padding: '20px', background: 'rgba(40,80,120,0.3)', borderRadius: '12px', marginBottom: '16px' }}>
                  <p style={{ color: '#a0c4e8', fontSize: '14px', margin: '0 0 16px 0' }}>
                    Enter your start year, end year, starting salary, and average annual raise. We'll calculate each year for you.
                  </p>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '16px', marginBottom: '16px' }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#80a8c8', fontSize: '12px' }}>Start Year</label>
                      <input type="number" value={quickFill.startYear} onChange={(e) => setQuickFill({ ...quickFill, startYear: parseInt(e.target.value) || 2020 })} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#80a8c8', fontSize: '12px' }}>End Year</label>
                      <input type="number" value={quickFill.endYear} onChange={(e) => setQuickFill({ ...quickFill, endYear: parseInt(e.target.value) || 2024 })} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#80a8c8', fontSize: '12px' }}>Starting Salary</label>
                      <input type="number" value={quickFill.startingSalary} onChange={(e) => setQuickFill({ ...quickFill, startingSalary: parseFloat(e.target.value) || 80000 })} />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#80a8c8', fontSize: '12px' }}>Annual Raise %</label>
                      <input type="number" step="0.5" value={quickFill.annualRaise} onChange={(e) => setQuickFill({ ...quickFill, annualRaise: parseFloat(e.target.value) || 3 })} />
                    </div>
                  </div>
                  
                  <button style={styles.applyBtn} onClick={applyQuickFill}>Generate Years</button>
                </div>
              ) : entryMode === 'paste' ? (
                <div style={{ padding: '20px', background: 'rgba(40,80,120,0.3)', borderRadius: '12px', marginBottom: '16px' }}>
                  <p style={{ color: '#a0c4e8', fontSize: '14px', margin: '0 0 4px 0' }}>
                    Copy two columns from Excel or Google Sheets (Year and Salary) and paste below.
                  </p>
                  <p style={{ color: '#607890', fontSize: '12px', margin: '0 0 16px 0' }}>
                    Accepts tab-separated, comma-separated, or pipe-separated data. Header rows are auto-skipped.
                  </p>
                  
                  <textarea
                    value={pasteText}
                    onChange={(e) => parsePastedData(e.target.value)}
                    onPaste={(e) => {
                      e.preventDefault();
                      const text = e.clipboardData.getData('text');
                      parsePastedData(text);
                    }}
                    placeholder={"Year\tSalary\n2018\t75000\n2019\t77500\n2020\t80000\n2021\t82500\n2022\t85000"}
                    rows={8}
                    style={{
                      width: '100%',
                      padding: '14px',
                      fontSize: '14px',
                      fontFamily: "'IBM Plex Mono', monospace",
                      background: 'rgba(20,40,70,0.8)',
                      border: '1px solid rgba(100,150,200,0.3)',
                      borderRadius: '8px',
                      color: '#e0f0ff',
                      outline: 'none',
                      resize: 'vertical',
                      lineHeight: '1.6'
                    }}
                  />

                  {pasteError && (
                    <div style={{ 
                      marginTop: '12px', padding: '12px', 
                      background: 'rgba(200,80,60,0.15)', 
                      border: '1px solid rgba(200,80,60,0.3)', 
                      borderRadius: '8px' 
                    }}>
                      <div style={{ color: '#f0a080', fontSize: '13px', whiteSpace: 'pre-line' }}>{pasteError}</div>
                    </div>
                  )}

                  {pastePreview && pastePreview.length > 0 && (
                    <div style={{ marginTop: '16px' }}>
                      <div style={{ 
                        display: 'flex', justifyContent: 'space-between', alignItems: 'center', 
                        marginBottom: '12px' 
                      }}>
                        <span style={{ color: '#60d080', fontSize: '14px', fontWeight: '500' }}>
                          ✓ {pastePreview.length} year{pastePreview.length !== 1 ? 's' : ''} detected
                        </span>
                        <button style={styles.applyBtn} onClick={applyPastedData}>
                          Apply {pastePreview.length} Years
                        </button>
                      </div>

                      <div style={{ 
                        background: 'rgba(20,40,70,0.5)', borderRadius: '8px', 
                        border: '1px solid rgba(100,150,200,0.2)', overflow: 'hidden'
                      }}>
                        <div style={{ 
                          display: 'grid', gridTemplateColumns: '80px 1fr', gap: '0',
                          padding: '8px 14px', borderBottom: '1px solid rgba(100,150,200,0.2)',
                          background: 'rgba(40,80,120,0.3)'
                        }}>
                          <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600' }}>Year</div>
                          <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600' }}>Salary</div>
                        </div>
                        {pastePreview.map((row, i) => (
                          <div key={i} style={{ 
                            display: 'grid', gridTemplateColumns: '80px 1fr', gap: '0',
                            padding: '6px 14px', 
                            borderBottom: i < pastePreview.length - 1 ? '1px solid rgba(100,150,200,0.08)' : 'none'
                          }}>
                            <div style={{ color: '#c0daf0', fontFamily: "'IBM Plex Mono', monospace", fontSize: '14px' }}>{row.year}</div>
                            <div style={{ color: '#e0f0ff', fontFamily: "'IBM Plex Mono', monospace", fontSize: '14px' }}>{new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(row.salary)}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <div>
                  <div style={{ display: 'grid', gridTemplateColumns: '100px 1fr 40px', gap: '8px', padding: '0 0 8px 0', borderBottom: '1px solid rgba(100,150,200,0.2)', marginBottom: '8px' }}>
                    <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600' }}>Year</div>
                    <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', fontWeight: '600' }}>Salary</div>
                    <div></div>
                  </div>

                  {edicYears.map((item, index) => (
                    <div key={`${item.year}-${index}`} className="entry-row">
                      <input type="number" value={item.year} onChange={(e) => updateEdicYear(index, 'year', e.target.value)} className="compact" />
                      <input type="number" value={item.salary} onChange={(e) => updateEdicYear(index, 'salary', e.target.value)} className="compact" />
                      <button className="remove-btn" onClick={() => removeEdicYear(index)}>×</button>
                    </div>
                  ))}

                  <div className="entry-row empty-row">
                    <input ref={yearInputRef} type="number" placeholder="Year" value={newYear} onChange={(e) => setNewYear(e.target.value)} onKeyDown={handleYearKeyDown} className="compact" />
                    <input ref={salaryInputRef} type="number" placeholder="Salary — press Enter to add" value={newSalary} onChange={(e) => setNewSalary(e.target.value)} onKeyDown={handleSalaryKeyDown} className="compact" />
                    <div></div>
                  </div>
                  
                  <p style={{ color: '#607890', fontSize: '12px', margin: '12px 0 0 0' }}>
                    Type a year and salary, then press Enter to add.
                  </p>
                </div>
              )}

              {edicYears.length > 0 && (
                <div style={{ marginTop: '24px', padding: '20px', background: 'rgba(40,80,120,0.4)', borderRadius: '12px', border: '1px solid rgba(100,180,240,0.3)' }}>
                  <h3 style={{ margin: '0 0 16px 0', color: '#c0daf0', fontSize: '16px' }}>Buyback Cost Estimate</h3>
                  
                  <div style={{ 
                    display: 'flex', gap: '16px', alignItems: 'flex-end', flexWrap: 'wrap',
                    marginBottom: '20px', padding: '16px', 
                    background: 'rgba(20,40,70,0.5)', borderRadius: '10px',
                    border: '1px solid rgba(100,150,200,0.2)'
                  }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: '6px', color: '#90b8d8', fontSize: '12px', fontWeight: '500' }}>
                        Planned lump-sum payment month
                      </label>
                      <div style={{ display: 'flex', gap: '10px' }}>
                        <select 
                          value={repaymentMonth} 
                          onChange={(e) => setRepaymentMonth(parseInt(e.target.value))}
                          style={{
                            background: 'rgba(20,40,70,0.8)',
                            border: '1px solid rgba(100,150,200,0.3)',
                            borderRadius: '8px',
                            padding: '8px 12px',
                            color: '#e0f0ff',
                            fontFamily: "'IBM Plex Sans', sans-serif",
                            fontSize: '14px',
                            outline: 'none',
                            cursor: 'pointer'
                          }}
                        >
                          {MONTH_NAMES.map((m, i) => <option key={i} value={i + 1}>{m}</option>)}
                        </select>
                        <span style={{ 
                          padding: '8px 12px', color: '#a0c4e8', fontSize: '14px',
                          background: 'rgba(20,40,70,0.8)', borderRadius: '8px',
                          border: '1px solid rgba(100,150,200,0.2)'
                        }}>2026</span>
                      </div>
                    </div>
                    <div style={{ color: '#607890', fontSize: '12px', lineHeight: '1.4', maxWidth: '320px' }}>
                      Interest accrues monthly — paying earlier in the year saves money. Uses official BRS cumulative factor tables.
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '20px' }}>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Years of Service</div>
                      <div style={{ ...styles.statValue, fontSize: '28px', color: '#e0f0ff' }}>{buybackCalculation.totalYears}</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Cost at 3.45%</div>
                      <div style={{ ...styles.statValue, fontSize: '28px', color: '#60d080' }}>{formatCurrencyFull(buybackCalculation.totalReducedRate)}</div>
                      <div style={{ color: '#60a080', fontSize: '11px' }}>Buyback interest (apply by Nov 2026)</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Cost at 6.9%</div>
                      <div style={{ ...styles.statValue, fontSize: '28px', color: '#f0a060' }}>{formatCurrencyFull(buybackCalculation.totalFullRate)}</div>
                      <div style={{ color: '#a08060', fontSize: '11px' }}>Actuarial interest</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>You Save</div>
                      <div style={{ ...styles.statValue, fontSize: '28px', color: '#60d080' }}>{formatCurrencyFull(buybackCalculation.savings)}</div>
                      <div style={{ color: '#60a080', fontSize: '11px' }}>With buyback interest rate</div>
                    </div>
                  </div>

                  <details style={{ marginTop: '20px' }}>
                    <summary style={{ color: '#90b8d8', cursor: 'pointer', fontSize: '14px' }}>View year-by-year breakdown</summary>
                    <table style={{ width: '100%', marginTop: '12px', fontSize: '13px', borderCollapse: 'collapse' }}>
                      <thead>
                        <tr style={{ borderBottom: '1px solid rgba(100,150,200,0.3)' }}>
                          <th style={{ padding: '8px', textAlign: 'left', color: '#80a8c8' }}>Year</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>Salary</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>Contrib</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>Factor</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>@ 3.45%</th>
                          <th style={{ padding: '8px', textAlign: 'right', color: '#80a8c8' }}>@ 6.9%</th>
                        </tr>
                      </thead>
                      <tbody>
                        {buybackCalculation.breakdown.map((row, i) => (
                          <tr key={i} style={{ borderBottom: '1px solid rgba(100,150,200,0.1)' }}>
                            <td style={{ padding: '8px' }}>{row.year}</td>
                            <td style={{ padding: '8px', textAlign: 'right', ...styles.statValue }}>{formatCurrencyFull(row.salary)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', ...styles.statValue }}>{formatCurrencyFull(row.contribution)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', color: '#90b8d8', fontSize: '12px' }}>{row.cumFactorReduced.toFixed(4)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', ...styles.statValue, color: '#60d080' }}>{formatCurrencyFull(row.amountReduced)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', ...styles.statValue, color: '#f0a060' }}>{formatCurrencyFull(row.amountFull)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <p style={{ color: '#607890', fontSize: '11px', margin: '8px 0 0 0' }}>
                      Factor = BRS cumulative interest to 12/31/2025. Totals include {MONTH_NAMES[repaymentMonth - 1]} 2026 partial-year interest.
                    </p>
                  </details>
                </div>
              )}
            </div>

            {/* Personal Info */}
            <div style={{ ...styles.card, padding: '28px', marginBottom: '24px' }}>
              <h2 style={{ fontSize: '18px', fontWeight: '600', margin: '0 0 24px 0', color: '#c0daf0', display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ width: '28px', height: '28px', background: 'linear-gradient(135deg, #3080b0, #60b0e0)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px' }}>2</span>
                Your Information
              </h2>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '24px' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Current Age</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="25" max="65" value={inputs.currentAge} onChange={(e) => handleInputChange('currentAge', parseInt(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '50px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{inputs.currentAge}</span>
                  </div>
                </div>


                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Current Annual Salary</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="40000" max="250000" step="1000" value={inputs.expectedFinalSalary} onChange={(e) => handleInputChange('expectedFinalSalary', parseInt(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '80px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{formatCurrency(inputs.expectedFinalSalary)}</span>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Expected Annual Salary Growth</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="0" max="6" step="0.5" value={inputs.salaryGrowthRate} onChange={(e) => handleInputChange('salaryGrowthRate', parseFloat(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '50px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{inputs.salaryGrowthRate}%</span>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>Life Expectancy</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <input type="range" min="70" max="100" value={inputs.lifeExpectancy} onChange={(e) => handleInputChange('lifeExpectancy', parseInt(e.target.value))} style={{ flex: 1 }} />
                    <span style={{ ...styles.statValue, minWidth: '50px', textAlign: 'right', fontSize: '20px', color: '#e0f0ff' }}>{inputs.lifeExpectancy}</span>
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', marginBottom: '8px', color: '#90b8d8', fontSize: '13px', fontWeight: '500' }}>
                    Planned Departure Age <span style={{ color: '#607890', fontWeight: '400' }}>(optional — leave blank if working until retirement)</span>
                  </label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <input 
                      type="number" 
                      placeholder="e.g. 55" 
                      value={inputs.departureAge || ''} 
                      onChange={(e) => handleInputChange('departureAge', e.target.value ? parseInt(e.target.value) : null)}
                      style={{ maxWidth: '120px' }}
                      className="compact"
                    />
                    {inputs.departureAge && (
                      <button 
                        style={{ ...styles.smallBtn, padding: '6px 10px' }} 
                        onClick={() => handleInputChange('departureAge', null)}
                      >
                        Clear
                      </button>
                    )}
                    {inputs.departureAge && inputs.departureAge > inputs.currentAge && (
                      <span style={{ color: '#80a8c8', fontSize: '13px' }}>
                        Service & salary freeze at age {inputs.departureAge}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Departure Notice */}
            {calculations.willDepart && (
              <div style={{ ...styles.card, padding: '20px', marginBottom: '24px', background: 'linear-gradient(145deg, rgba(80,60,30,0.6), rgba(60,45,20,0.7))', border: '1px solid rgba(200,150,80,0.3)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                  <span style={{ fontSize: '20px' }}>📋</span>
                  <div>
                    <div style={{ color: '#e0c080', fontWeight: '600', marginBottom: '4px' }}>Early Departure at Age {calculations.departureAge}</div>
                    <div style={{ color: '#b0a080', fontSize: '13px' }}>
                      Service freezes at {calculations.frozenServiceYears?.toFixed(1)} years • 
                      Salary freezes at {formatCurrency(calculations.frozenAvgSalary)} avg • 
                      Pension starts at age {calculations.minRetirementAge}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Key Insights */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px', marginBottom: '24px' }}>
              {calculations.optimalWithBuyback && (
                <div style={{ ...styles.highlightCard, padding: '24px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                    <span style={{ color: '#80c0e8', fontSize: '13px', fontWeight: '500', textTransform: 'uppercase' }}>Best with Buyback</span>
                    <span style={{ ...styles.badge, ...styles.badgeOptimal }}>Recommended</span>
                  </div>
                  <div style={{ ...styles.statValue, fontSize: '42px', color: '#e0f8ff', marginBottom: '8px' }}>Age {calculations.optimalWithBuyback.retireAge}</div>
                  <div style={{ color: '#a0d0f0', fontSize: '14px', marginBottom: '16px' }}>{calculations.optimalWithBuyback.serviceWithBuyback.toFixed(1)} years service • {formatPercent(calculations.optimalWithBuyback.percentWith)} of salary</div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', paddingTop: '16px', borderTop: '1px solid rgba(100,150,200,0.2)' }}>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Annual Pension</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: '#60d060' }}>{formatCurrency(calculations.optimalWithBuyback.annualPensionWith)}</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Lifetime Total</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: '#60d060' }}>{formatCurrency(calculations.optimalWithBuyback.lifetimeBenefitWith)}</div>
                    </div>
                  </div>
                </div>
              )}

              {calculations.bestBuybackROI && edicYears.length > 0 && (
                <div style={{ ...styles.card, padding: '24px' }}>
                  <div style={{ color: '#80c0e8', fontSize: '13px', fontWeight: '500', textTransform: 'uppercase', marginBottom: '16px' }}>Buyback Investment</div>
                  <div style={{ ...styles.statValue, fontSize: '42px', color: '#f0c060', marginBottom: '8px' }}>{formatCurrency(calculations.bestBuybackROI.buybackCost)}</div>
                  <div style={{ color: '#a0d0f0', fontSize: '14px', marginBottom: '16px' }}>Cost at 3.45% rate</div>
                  <div style={{ paddingTop: '16px', borderTop: '1px solid rgba(100,150,200,0.2)' }}>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Lifetime ROI</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: calculations.bestBuybackROI.roi > 0 ? '#60d060' : '#e06060' }}>{formatPercent(calculations.bestBuybackROI.roi)}</div>
                    </div>
                  </div>
                </div>
              )}

              {calculations.optimalWithoutBuyback && (
                <div style={{ ...styles.card, padding: '24px' }}>
                  <div style={{ color: '#80c0e8', fontSize: '13px', fontWeight: '500', textTransform: 'uppercase', marginBottom: '16px' }}>Without Buyback</div>
                  <div style={{ ...styles.statValue, fontSize: '42px', color: '#c0d8e8', marginBottom: '8px' }}>Age {calculations.optimalWithoutBuyback.retireAge}</div>
                  <div style={{ color: '#a0d0f0', fontSize: '14px', marginBottom: '16px' }}>{calculations.optimalWithoutBuyback.serviceAtRetirement.toFixed(1)} years service • {formatPercent(calculations.optimalWithoutBuyback.percentWithout)} of salary</div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', paddingTop: '16px', borderTop: '1px solid rgba(100,150,200,0.2)' }}>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Annual Pension</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: '#a0c8e0' }}>{formatCurrency(calculations.optimalWithoutBuyback.annualPensionWithout)}</div>
                    </div>
                    <div>
                      <div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '4px' }}>Lifetime Total</div>
                      <div style={{ ...styles.statValue, fontSize: '18px', color: '#a0c8e0' }}>{formatCurrency(calculations.optimalWithoutBuyback.lifetimeBenefitWithout)}</div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Scenario Table */}
            <div style={{ ...styles.card, padding: '28px', marginBottom: '24px' }}>
              <h2 style={{ fontSize: '18px', fontWeight: '600', margin: '0 0 20px 0', color: '#c0daf0', display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ width: '28px', height: '28px', background: 'linear-gradient(135deg, #3080b0, #60b0e0)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px' }}>3</span>
                All Retirement Scenarios
              </h2>

              {calculations.neverVestedWith && edicYears.length > 0 && (
                <div style={{ 
                  marginBottom: '20px', padding: '16px 20px', 
                  background: 'rgba(220,50,50,0.15)', 
                  borderRadius: '12px', 
                  border: '1px solid rgba(220,50,50,0.4)' 
                }}>
                  <strong style={{ color: '#f07070', fontSize: '15px' }}>⚠️ Not Vested</strong>
                  <p style={{ color: '#e0a0a0', margin: '8px 0 0 0', fontSize: '14px', lineHeight: '1.5' }}>
                    Your combined EDIC buyback years ({edicYears.length}) plus projected city service years do not reach the {calculations.VESTING_YEARS}-year vesting requirement, even at age 70. 
                    You must have at least {calculations.VESTING_YEARS} years of creditable service to be eligible for a pension.
                  </p>
                </div>
              )}

              {calculations.neverVestedWithout && !calculations.neverVestedWith && edicYears.length > 0 && (
                <div style={{ 
                  marginBottom: '20px', padding: '16px 20px', 
                  background: 'rgba(230,160,40,0.15)', 
                  borderRadius: '12px', 
                  border: '1px solid rgba(230,160,40,0.4)' 
                }}>
                  <strong style={{ color: '#f0c060', fontSize: '15px' }}>⚠️ Buyback Required for Vesting</strong>
                  <p style={{ color: '#d0c090', margin: '8px 0 0 0', fontSize: '14px', lineHeight: '1.5' }}>
                    Without buying back your EDIC service, you will not reach the {calculations.VESTING_YEARS}-year vesting requirement. 
                    The buyback is essential for pension eligibility in your case.
                  </p>
                </div>
              )}

              <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid rgba(100,150,200,0.3)' }}>
                      {['Retire Age', 'Service', 'w/ Buyback', 'Avg Salary', 'Avg w/ BB', '% (No BB)', '% (w/ BB)', 'Annual (No BB)', 'Annual (w/ BB)', 'Status'].map((h) => (
                        <th key={h} style={{ padding: '12px 8px', textAlign: h === 'Status' ? 'center' : (h === 'Retire Age' ? 'left' : 'right'), color: '#80a8c8', fontWeight: '600', fontSize: '11px', textTransform: 'uppercase' }}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {calculations.scenarios.filter(s => !s.notEligible && !s.alreadyPast).map((s) => {
                      const isOptimal = calculations.optimalWithBuyback?.retireAge === s.retireAge;
                      const isSelected = selectedScenario === s.retireAge;
                      return (
                        <tr key={s.retireAge} className="scenario-row" onClick={() => setSelectedScenario(isSelected ? null : s.retireAge)}
                          style={{ borderBottom: '1px solid rgba(100,150,200,0.1)', background: isSelected ? 'rgba(60,140,200,0.25)' : (isOptimal ? 'rgba(60,160,100,0.1)' : undefined), borderLeft: isSelected ? '3px solid #60b0e0' : '3px solid transparent', cursor: 'pointer' }}>
                          <td style={{ padding: '14px 8px', fontWeight: isOptimal ? '600' : '400' }}>
                            {s.retireAge}
                            {isOptimal && <span style={{ ...styles.badge, ...styles.badgeOptimal, marginLeft: '8px' }}>Best</span>}
                          </td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right' }}>{s.serviceAtRetirement.toFixed(1)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right', color: '#80c8e8' }}>{s.serviceWithBuyback.toFixed(1)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right' }}>{formatCurrency(s.avgSalaryWithout)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right', color: '#80c8e8' }}>{formatCurrency(s.avgSalaryWith)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right' }}>{formatPercent(s.percentWithout)}{s.hitsMaxWithout && <span style={{ marginLeft: '4px', color: '#60a0e0' }}>★</span>}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right', color: '#80c8e8' }}>{formatPercent(s.percentWith)}{s.hitsMaxWith && <span style={{ marginLeft: '4px', color: '#60a0e0' }}>★</span>}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right' }}>{formatCurrency(s.annualPensionWithout)}</td>
                          <td style={{ ...styles.statValue, padding: '14px 8px', textAlign: 'right', color: '#60d080' }}>{formatCurrency(s.annualPensionWith)}</td>
                          <td style={{ padding: '14px 8px', textAlign: 'center' }}>
                            {s.notVestedWith ? <span style={{ ...styles.badge, background: 'linear-gradient(135deg, #b71c1c, #e53935)', color: 'white' }}>Not Vested</span> : s.buybackWasted ? <span style={{ ...styles.badge, ...styles.badgeWarning }}>BB Wasted</span> : s.hitsMaxWith ? <span style={{ ...styles.badge, ...styles.badgeMax }}>Max 80%</span> : null}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              <div style={{ marginTop: '16px', fontSize: '12px', color: '#80a8c8' }}>★ = Hits 80% max | BB = Buyback | Click row for details</div>
              
              <div style={{ marginTop: '24px', paddingTop: '20px', borderTop: '1px solid rgba(100,150,200,0.2)', textAlign: 'center' }}>
                <div style={{ display: 'flex', justifyContent: 'center', gap: '16px', flexWrap: 'wrap' }}>
                  <button 
                    onClick={generatePDF}
                    style={{ 
                      background: 'linear-gradient(135deg, #2e7d32, #4caf50)', 
                      border: 'none', 
                      color: 'white', 
                      padding: '14px 28px', 
                      borderRadius: '10px', 
                      cursor: 'pointer', 
                      fontFamily: 'inherit', 
                      fontSize: '15px', 
                      fontWeight: '600',
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '10px',
                      boxShadow: '0 4px 12px rgba(46, 125, 50, 0.3)'
                    }}
                  >
                    <span style={{ fontSize: '18px' }}>📄</span>
                    Download PDF Report
                  </button>
                  <button 
                    onClick={generateDepartureChartPDF}
                    style={{ 
                      background: 'linear-gradient(135deg, #1565c0, #42a5f5)', 
                      border: 'none', 
                      color: 'white', 
                      padding: '14px 28px', 
                      borderRadius: '10px', 
                      cursor: 'pointer', 
                      fontFamily: 'inherit', 
                      fontSize: '15px', 
                      fontWeight: '600',
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '10px',
                      boxShadow: '0 4px 12px rgba(21, 101, 192, 0.3)'
                    }}
                  >
                    <span style={{ fontSize: '18px' }}>📊</span>
                    Download Departure Chart
                  </button>
                </div>
                <p style={{ color: '#607890', fontSize: '12px', marginTop: '10px' }}>
                  Full report with all scenarios, or a chart showing pension by departure age (45–65)
                </p>
              </div>
            </div>

            {/* Selected Scenario Detail */}
            {selectedScenario && (() => {
              const s = calculations.scenarios.find(sc => sc.retireAge === selectedScenario);
              if (!s) return null;
              return (
                <div style={{ ...styles.highlightCard, padding: '28px', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '18px', fontWeight: '600', margin: '0 0 20px 0', color: '#c0daf0' }}>Detailed Analysis: Retire at Age {s.retireAge}</h2>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px' }}>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Years Until Retirement</div><div style={{ ...styles.statValue, fontSize: '24px' }}>{s.yearsUntilRetirement}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Years Collecting</div><div style={{ ...styles.statValue, fontSize: '24px' }}>{s.yearsCollecting}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Highest {calculations.avgYears}-Yr Avg (No BB)</div><div style={{ ...styles.statValue, fontSize: '24px' }}>{formatCurrency(s.avgSalaryWithout)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Highest {calculations.avgYears}-Yr Avg (w/ BB)</div><div style={{ ...styles.statValue, fontSize: '24px', color: '#80c8e8' }}>{formatCurrency(s.avgSalaryWith)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Buyback Cost (3.45%)</div><div style={{ ...styles.statValue, fontSize: '24px', color: '#60d080' }}>{formatCurrencyFull(s.buybackCost)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Buyback Cost (6.9%)</div><div style={{ ...styles.statValue, fontSize: '24px', color: '#f0a060' }}>{formatCurrencyFull(s.buybackCostFull)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Annual Benefit from BB</div><div style={{ ...styles.statValue, fontSize: '24px', color: s.annualBenefit > 0 ? '#60d080' : '#a0a0a0' }}>+{formatCurrency(s.annualBenefit)}/yr</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Lifetime Gain from BB</div><div style={{ ...styles.statValue, fontSize: '24px', color: s.lifetimeGain > 0 ? '#60d080' : '#a0a0a0' }}>{formatCurrency(s.lifetimeGain)}</div></div>
                    <div><div style={{ color: '#80a8c8', fontSize: '11px', textTransform: 'uppercase', marginBottom: '6px' }}>Net Gain (After Cost)</div><div style={{ ...styles.statValue, fontSize: '24px', color: s.netLifetimeGain > 0 ? '#60d080' : '#e06060' }}>{formatCurrency(s.netLifetimeGain)}</div></div>
                  </div>
                  {s.buybackWasted && (
                    <div style={{ marginTop: '20px', padding: '16px', background: 'rgba(230,100,50,0.15)', borderRadius: '12px', border: '1px solid rgba(230,100,50,0.3)' }}>
                      <strong style={{ color: '#f0a060' }}>⚠️ Buyback Warning:</strong>
                      <span style={{ color: '#d0c0a0', marginLeft: '8px' }}>You would already hit the 80% max without buyback. Buying back EDIC service would not increase your pension.</span>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Feedback Form */}
            <div 
              id="feedback-form"
              style={{
                ...styles.card,
                padding: '28px',
                marginBottom: '24px',
                background: 'linear-gradient(145deg, rgba(40,70,100,0.4), rgba(30,60,90,0.5))',
                border: '1px solid rgba(100,150,200,0.3)'
              }}
            >
              <h2 style={{ 
                fontSize: '18px', 
                fontWeight: '600', 
                margin: '0 0 8px 0', 
                color: '#c0daf0' 
              }}>
                Send Feedback to Ted
              </h2>
              <p style={{
                fontSize: '14px',
                color: '#8ab4d8',
                marginBottom: '20px',
                lineHeight: '1.5'
              }}>
                Questions about the calculator? Found a bug? Have suggestions for improvement?
              </p>
              
              <form 
                action="https://formspree.io/f/mreagbzk" 
                method="POST"
                style={{ maxWidth: '600px' }}
              >
                <div style={{ marginBottom: '16px' }}>
                  <label style={{ 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: 500,
                    color: '#a0c8e8',
                    fontSize: '14px'
                  }}>
                    Your Email:
                  </label>
                  <input 
                    type="email" 
                    name="email" 
                    required
                    style={{
                      width: '100%',
                      padding: '12px',
                      fontSize: '15px',
                      background: 'rgba(20,40,70,0.6)',
                      border: '1px solid rgba(100,150,200,0.3)',
                      borderRadius: '8px',
                      color: '#e0f0ff',
                      fontFamily: 'IBM Plex Sans, sans-serif',
                      outline: 'none'
                    }}
                  />
                </div>
                
                <div style={{ marginBottom: '16px' }}>
                  <label style={{ 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: 500,
                    color: '#a0c8e8',
                    fontSize: '14px'
                  }}>
                    Message:
                  </label>
                  <textarea 
                    name="message" 
                    rows="5" 
                    required
                    placeholder="Describe your question, bug report, or suggestion..."
                    style={{
                      width: '100%',
                      padding: '12px',
                      fontSize: '15px',
                      background: 'rgba(20,40,70,0.6)',
                      border: '1px solid rgba(100,150,200,0.3)',
                      borderRadius: '8px',
                      color: '#e0f0ff',
                      fontFamily: 'IBM Plex Sans, sans-serif',
                      outline: 'none',
                      resize: 'vertical'
                    }}
                  />
                </div>
                
                <button 
                  type="submit"
                  style={{
                    padding: '12px 24px',
                    fontSize: '15px',
                    fontWeight: 600,
                    color: 'white',
                    background: 'linear-gradient(135deg, #3080b0, #60b0e0)',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontFamily: 'IBM Plex Sans, sans-serif',
                    boxShadow: '0 4px 12px rgba(60,176,224,0.3)'
                  }}
                >
                  Send Message
                </button>
              </form>
            </div>

            {/* Footer */}
            <div style={{ textAlign: 'center', padding: '24px', color: '#607890', fontSize: '12px', borderTop: '1px solid rgba(100,150,200,0.1)' }}>
              <p style={{ margin: 0 }}>This is an experiment subject to errors. Do not make any decisions based on its output. Consult Human Resources for official guidance.</p>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
